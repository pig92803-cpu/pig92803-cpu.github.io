<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣歷史與文化地圖</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- D3 & TopoJSON -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        .cursor-zoom-in { cursor: zoom-in; }
        .cursor-zoom-out { cursor: zoom-out; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen flex items-center justify-center bg-gray-100 text-gray-500">
        <div class="text-center">
            <h2 class="text-xl font-bold mb-2">正在載入地圖應用程式...</h2>
            <p class="text-sm">初始化中，請稍候。</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. 錯誤捕捉元件 ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-10 text-red-600">
                            <h1 className="text-2xl font-bold">應用程式發生錯誤</h1>
                            <p>這可能是程式碼語法或執行順序的問題。</p>
                            <pre className="mt-4 bg-red-50 p-4 rounded border border-red-200 text-sm overflow-auto">{this.state.error.toString()}</pre>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- 2. SVG 圖標元件定義 (放在最外層，避免依賴順序問題) ---
        const Icon = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const MapIcon = (props) => <Icon {...props}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" /><line x1="8" y1="2" x2="8" y2="18" /><line x1="16" y1="6" x2="16" y2="22" /></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>;
        const ZoomIn = (props) => <Icon {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></Icon>;
        const ZoomOut = (props) => <Icon {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></Icon>;
        const Maximize = (props) => <Icon {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></Icon>;
        const BookOpen = (props) => <Icon {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></Icon>;
        const ChevronRight = (props) => <Icon {...props}><polyline points="9 18 15 12 9 6" /></Icon>;
        const Feather = (props) => <Icon {...props}><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z" /><line x1="16" y1="8" x2="2" y2="22" /><line x1="17.5" y1="15" x2="9" y2="15" /></Icon>;
        const Sword = (props) => <Icon {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" /><line x1="13" y1="19" x2="19" y2="13" /><line x1="16" y1="16" x2="20" y2="20" /><line x1="19" y1="21" x2="21" y2="19" /></Icon>;
        const Move = (props) => <Icon {...props}><polyline points="5 9 2 12 5 15" /><polyline points="9 5 12 2 15 5" /><polyline points="15 19 12 22 9 19" /><polyline points="19 9 22 12 19 15" /><line x1="2" y1="12" x2="22" y2="12" /><line x1="12" y1="2" x2="12" y2="22" /></Icon>;
        const Users = (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></Icon>;
        const Brush = (props) => <Icon {...props}><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08" /><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2.5 2.24 0 .46.48.8.97.8 2.52 0 5-2.53 5-5.06 0-.83-.47-1-1.03-1z" /></Icon>;
        const Send = (props) => <Icon {...props}><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></Icon>;
        const Loader2 = (props) => <Icon {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;

        const normalizeName = (name) => name ? name.replace(/台/g, '臺') : "";

        // --- 3. 靜態數據資料庫 ---
        const countyData = {
            "臺北市": { population: "2,504,000", area: "271.80 km²", feature: "首都、台北101、故宮" },
            "新北市": { population: "4,040,000", area: "2,052.57 km²", feature: "耶誕城、淡水老街、九份" },
            "桃園市": { population: "2,320,000", area: "1,220.95 km²", feature: "國際機場、石門水庫" },
            "臺中市": { population: "2,850,000", area: "2,214.90 km²", feature: "逢甲夜市、國家歌劇院" },
            "臺南市": { population: "1,860,000", area: "2,191.65 km²", feature: "古蹟、美食之都" },
            "高雄市": { population: "2,730,000", area: "2,951.85 km²", feature: "愛河、駁二、高雄港" },
            "基隆市": { population: "360,000", area: "132.76 km²", feature: "廟口夜市、雨都" },
            "新竹市": { population: "456,000", area: "104.15 km²", feature: "科學園區、城隍廟" },
            "嘉義市": { population: "263,000", area: "60.03 km²", feature: "火雞肉飯、管樂節" },
            "新竹縣": { population: "590,000", area: "1,427.54 km²", feature: "客家文化、內灣老街" },
            "苗栗縣": { population: "534,000", area: "1,820.31 km²", feature: "勝興車站、龍騰斷橋" },
            "彰化縣": { population: "1,240,000", area: "1,074.40 km²", feature: "八卦山大佛、鹿港" },
            "南投縣": { population: "477,000", area: "4,106.44 km²", feature: "日月潭、清境農場" },
            "雲林縣": { population: "660,000", area: "1,290.83 km²", feature: "劍湖山、北港朝天宮" },
            "嘉義縣": { population: "485,000", area: "1,903.64 km²", feature: "阿里山、故宮南院" },
            "屏東縣": { population: "795,000", area: "2,775.60 km²", feature: "墾丁、鵝鑾鼻" },
            "宜蘭縣": { population: "450,000", area: "2,143.63 km²", feature: "礁溪溫泉、幾米公園" },
            "花蓮縣": { population: "317,000", area: "4,628.57 km²", feature: "太魯閣、七星潭" },
            "臺東縣": { population: "211,000", area: "3,515.25 km²", feature: "鹿野高台熱氣球、伯朗大道" },
            "澎湖縣": { population: "108,000", area: "126.86 km²", feature: "花火節、玄武岩" },
            "金門縣": { population: "143,000", area: "151.66 km²", feature: "戰地風光、高粱酒" },
            "連江縣": { population: "14,000", area: "28.80 km²", feature: "藍眼淚、芹壁聚落" },
        };

        const countyHistory = {
            "臺南市": { indigenous: "西拉雅族的原鄉", dutch: "熱蘭遮城與普羅民遮城", qing: "一府（台灣府）", resistance: "噍吧哖事件", japanese: "糖業重鎮", modern: "文化古都與南科" },
            "新北市": { indigenous: "凱達格蘭族", dutch: "西班牙人據點", qing: "淡水開港", resistance: "簡大獅抗日", japanese: "礦業興盛", modern: "全台最大衛星城市" },
            "基隆市": { indigenous: "巴賽族", dutch: "聖薩爾瓦多城", qing: "劉銘傳鐵路起點", resistance: "乙未戰爭首戰", japanese: "台灣玄關", modern: "港都轉型" },
            "臺北市": { indigenous: "凱達格蘭族", dutch: "採硫磺", qing: "建城與電氣化", resistance: "芝山岩事件", japanese: "政經中心", modern: "國際金融中心" },
            "高雄市": { indigenous: "馬卡道族", dutch: "打狗漁村", qing: "打狗開港", resistance: "林少貓抗日", japanese: "南進基地", modern: "工業與港灣城市" },
            "彰化縣": { indigenous: "巴布薩族", dutch: "半線社", qing: "一府二鹿", resistance: "八卦山之役", japanese: "米倉", modern: "精密機械重鎮" },
            "南投縣": { indigenous: "泰雅、布農、邵族", dutch: "-", qing: "內山開發", resistance: "霧社事件", japanese: "日月潭水力發電", modern: "觀光大縣" },
            "屏東縣": { indigenous: "排灣、魯凱族", dutch: "探金", qing: "牡丹社事件", resistance: "步月樓之役", japanese: "熱帶農業", modern: "國境之南" },
            "雲林縣": { indigenous: "洪雅族", qing: "設縣", resistance: "鐵國山", japanese: "糖都", modern: "農業首都" },
            "桃園市": { indigenous: "泰雅族", qing: "水利建設", resistance: "乙未戰爭戰場", japanese: "桃園大圳", modern: "國門之都" },
            "苗栗縣": { indigenous: "賽夏族", qing: "樟腦產業", resistance: "苗栗事件", japanese: "出磺坑油井", modern: "山城文化" },
            "新竹市": { indigenous: "道卡斯族", qing: "竹塹城", resistance: "乙未戰爭", japanese: "玻璃工業", modern: "台灣矽谷" },
            "新竹縣": { indigenous: "泰雅、賽夏族", qing: "金廣福墾號", resistance: "北埔事件", japanese: "茶葉與林業", modern: "科技聚落" },
            "嘉義市": { indigenous: "洪雅族", qing: "嘉義賜名", resistance: "乙未戰爭", japanese: "林業樞紐", modern: "管樂之都" },
            "嘉義縣": { indigenous: "鄒族", qing: "笨港", resistance: "-", japanese: "阿里山鐵路", modern: "故宮南院" },
            "臺中市": { indigenous: "拍瀑拉族", qing: "霧峰林家", resistance: "-", japanese: "市區改正", modern: "機械產業重鎮" },
            "宜蘭縣": { indigenous: "噶瑪蘭族", qing: "吳沙開蘭", resistance: "-", japanese: "太平山林業", modern: "環保觀光" },
            "花蓮縣": { indigenous: "阿美、太魯閣族", qing: "開山撫番", resistance: "七腳川事件", japanese: "吉野移民村", modern: "觀光大縣" },
            "臺東縣": { indigenous: "卑南、達悟族", qing: "後山開發", resistance: "麻豆欄事件", japanese: "製糖移民", modern: "史前文化與觀光" },
            "澎湖縣": { indigenous: "早期漁獵中繼", dutch: "荷蘭前哨", qing: "中法戰爭", resistance: "-", japanese: "軍事要塞", modern: "海島觀光" },
            "金門縣": { indigenous: "-", dutch: "鄭氏基地", qing: "僑鄉", resistance: "-", japanese: "日軍佔領", modern: "戰地前線" },
            "連江縣": { indigenous: "-", dutch: "-", qing: "漁業基地", resistance: "-", japanese: "-", modern: "馬祖戰地" }
        };

        const historyPeriods = [
            { id: 'indigenous', name: '原住民族', year: '遠古 - 現代', desc: '土地最早的主人，南島語族的智慧', color: '#16a34a', icon: Feather },
            { id: 'dutch', name: '荷西與鄭氏', year: '1624 - 1683', desc: '大航海時代與東寧王國', color: '#d97706', icon: MapIcon },
            { id: 'qing', name: '清治時期', year: '1683 - 1895', desc: '渡台禁令鬆綁、開港通商', color: '#059669', icon: Clock },
            { id: 'resistance', name: '抗日行動', year: '1895 - 1915', desc: '乙未戰爭與武裝抗爭', color: '#b91c1c', icon: Sword },
            { id: 'japanese', name: '日治建設', year: '1895 - 1945', desc: '現代化基礎建設與產業開發', color: '#be123c', icon: Clock },
            { id: 'modern', name: '戰後與現代', year: '1945 - 至今', desc: '經濟奇蹟與民主化', color: '#2563eb', icon: Info },
        ];

        const tribesData = [
            {
                name: "阿美族 (Amis)",
                feature: "人口最多，母系社會，樂天知命。",
                festival: "豐年祭 (Ilisin)",
                symbol: "【八角星 Malataw】象徵宇宙星辰與母親的力量。",
                tattoo: "無顯著紋面文化。",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Indigenous_group_dancers_at_Amis_Music_Festival_2016_IMF0936.jpg/1200px-Indigenous_group_dancers_at_Amis_Music_Festival_2016_IMF0936.jpg",
                symbol_img: "https://i.pinimg.com/474x/08/d4/77/08d477607e63ec501a5167eb2c857a5e.jpg",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/f59e0b/ffffff?text=豐年祭"
            },
            {
                name: "泰雅族 (Atayal)",
                feature: "嚴守祖訓 Gaga，善於織布。",
                festival: "祖靈祭 (Mahal Sminhu)",
                symbol: "菱形紋 (祖靈之眼)",
                tattoo: "【有紋面】象徵成年與英勇。",
                image: "https://s.newtalk.tw/album/news/119/5ab3a2cd1c020.jpg",
                symbol_img: "https://i.ytimg.com/vi/L9u6ZTchsHw/sddefault.jpg",
                tattoo_img: "https://placehold.co/100x100/be123c/ffffff?text=泰雅+紋面",
                festival_img: "https://placehold.co/100x100/059669/ffffff?text=祖靈祭"
            },
            {
                name: "排灣族 (Paiwan)",
                feature: "階級制度嚴謹，工藝精湛。",
                festival: "五年祭 (Maleveq)",
                symbol: "百步蛇紋、人頭紋",
                tattoo: "【有紋身】貴族專屬紋樣。",
                image: "https://epaper.naer.edu.tw/storage/img/edm_237_4065_img_0.jpg", 
                symbol_img: "https://i.pinimg.com/736x/dd/08/fe/dd08fe2802f33f4e614e3b9aaa0f3c43.jpg",
                tattoo_img: "https://placehold.co/100x100/1e293b/ffffff?text=排灣+紋身",
                festival_img: "https://placehold.co/100x100/d97706/ffffff?text=五年祭"
            },
            {
                name: "布農族 (Bunun)",
                feature: "八部合音，居中央山脈。",
                festival: "射耳祭 (Malahtangia)",
                symbol: "八部合音、玉山",
                tattoo: "【有紋面】與獵團成就相關。",
                image: "https://www.ysnp.gov.tw/FileDownload/ContentManagement/20200830013134984809543.jpg",
                symbol_img: "https://ihc.cip.gov.tw/ihcfile/EJournals/44/Content/P121_0003.jpg",
                tattoo_img: "https://placehold.co/100x100/475569/ffffff?text=布農+紋面",
                festival_img: "https://placehold.co/100x100/475569/ffffff?text=射耳祭"
            },
            {
                name: "卑南族 (Puyuma)",
                feature: "會所制度嚴謹，年齡階級。",
                festival: "大獵祭 (Mangamangayau)",
                symbol: "鹿、猴、太陽紋",
                tattoo: "無顯著紋面文化。",
                image: "https://dcm.s3.hicloud.net.tw/new/collection/2020-10-06/e0d2b47b-996e-4394-bbb0-bc2a71e55570/6ac2e235-a321-4ec4-a2a8-a7642c1678a8.jpg",
                symbol_img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEicM6vVsq3Gcs74C04moQrTCZHZpwxiVVW50qsh3oUx8gUDLxAQE-x8936_Fwy4oQkH8u6lmjVV720I-a4tRE1Kf_LrQHleM5vltt4jzqS5HE9w4-WwPxLOU7MKEy_7ODMjdfntAWRaGNuG/s1600/%E7%94%B7%E5%A5%B3%E7%9B%B8%E9%96%93%E4%BA%BA%E5%BD%A2%E8%88%9E%E8%B9%88%E7%B4%8B_%E6%9D%8E%E8%8E%8E%E8%8E%89%E3%80%82%E3%80%8A%E5%8F%B0%E7%81%A3%E5%8E%9F%E4%BD%8F%E6%B0%91%E8%A1%A3%E9%A3%BE%E6%96%87%E5%8C%96%EF%BC%9A%E5%82%B3%E7%B5%B1%E2%80%A7%E6%84%8F%E7%BE%A9%E2%80%A7%E5%9C%96%E8%AA%AA%E3%80%8B%E3%80%82%E5%8D%97%E5%A4%A9%E6%9B%B8%E5%B1%80%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8%E3%80%821998%E3%80%82%E9%A0%81305.JPG",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/b45309/ffffff?text=大獵祭"
            },
            {
                name: "魯凱族 (Rukai)",
                feature: "百合花飾，石板屋。",
                festival: "小米收穫祭",
                symbol: "百步蛇紋、百合花",
                tattoo: "【有紋身】貴族女性手文。",
                image: "https://tcmbdata.culture.tw/api/collection/image/Culture_People?uid=488269",
                symbol_img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQpUeqF-zIj7nzCcDV1aB4J5LBtBAOQOemiyA&s",
                tattoo_img: "https://placehold.co/100x100/334155/ffffff?text=魯凱+紋身",
                festival_img: "https://placehold.co/100x100/4f46e5/ffffff?text=收穫祭"
            },
            {
                name: "鄒族 (Tsou)",
                feature: "男子會所 Kuba。",
                festival: "戰祭 (Mayasvi)",
                symbol: "火紅圖騰",
                tattoo: "無顯著紋面文化。",
                image: "https://channelplus.ner.gov.tw/api/images/5c90b51bbe337e0007ff35b0/1600/jpeg",
                symbol_img: "https://i.pinimg.com/736x/5b/6c/1d/5b6c1d66b2a967f60f60076959946602.jpg",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/dc2626/ffffff?text=戰祭"
            },
            {
                name: "賽夏族 (Saisiyat)",
                feature: "分佈於新竹與苗栗交界，獨特的「臀鈴」樂器，保留矮黑人傳說。",
                festival: "矮靈祭 (PaSta'ay)",
                symbol: "幾何紋路、卍字紋",
                tattoo: "【有紋面】額頭與下巴線條。",
                image: "https://channelplus.ner.gov.tw/api/images/5c9326b1be337e0007fff9bc/1600/jpeg",
                symbol_img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT5JOr7XWXOg_3-TS0-ArW-C-3Q8u4tr5Culg&s",
                tattoo_img: "https://placehold.co/100x100/7f1d1d/ffffff?text=賽夏+紋面",
                festival_img: "https://placehold.co/100x100/f0ab06/ffffff?text=矮靈祭"
            },
            {
                name: "雅美族 (Tao)",
                feature: "海洋民族，拼板舟。",
                festival: "飛魚祭 (Rayon)",
                symbol: "船眼紋、人形紋",
                tattoo: "【有紋身】波浪狀紋飾。",
                image: "https://dcm.s3.hicloud.net.tw/new/collection/2020-10-06/72e2136b-d6fb-409a-b5e8-edf9827a6d53/b9c7da52-3d4e-41ad-a6b3-e73350fa6524.jpg",
                symbol_img: "https://i.pinimg.com/474x/a7/4c/66/a74c668285829f5d75fa7bbb853a30ca.jpg",
                tattoo_img: "https://placehold.co/100x100/1e40af/ffffff?text=達悟+紋身",
                festival_img: "https://placehold.co/100x100/0891b2/ffffff?text=飛魚祭"
            },
            {
                name: "邵族 (Thao)",
                feature: "日月潭，祖靈籃。",
                festival: "祖靈祭 (Lus'an)",
                symbol: "白鰻、鹿",
                tattoo: "無顯著紋面文化。",
                image: "https://data.boch.gov.tw/old_upload/_upload/Assets_new/relate_cultural/134728/photo/%E9%82%B5%E6%97%8F%E7%A5%96%E9%9D%88%E7%A5%AD1.jpg",
                symbol_img: "https://www.kirin.com.tw/barbeer/tingyuanminbar/content/images/2022/thao_creature.png",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/854d0e/ffffff?text=祖靈祭"
            },
            {
                name: "噶瑪蘭族 (Kavalan)",
                feature: "香蕉絲織布。",
                festival: "海祭 (Laligi)",
                symbol: "海浪與植物紋",
                tattoo: "無顯著紋面文化。",
                image: "https://upload.wikimedia.org/wikipedia/commons/9/9d/Women_of_Kebalan_20150626.jpg",
                symbol_img: "https://unews.nccu.edu.tw/wp-content/uploads/2021/05/a746691d8a9a4aa11c17ce1714c5564d-1024x327.jpg",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/0f766e/ffffff?text=海祭"
            },
            {
                name: "太魯閣族 (Truku)",
                feature: "崇尚彩虹橋 (Hakaw Utux) 傳說，男子善獵，女子善織。",
                festival: "祖靈祭 (Mgay Bari)",
                symbol: "菱形紋 (祖靈的眼睛)，與泰雅族相似，代表祖靈的守護與監察。",
                tattoo: "【有紋面】與泰雅族類似，紋於額頭與下巴，象徵通過考驗，能歸於祖靈。",
                image: "https://dcm.s3.hicloud.net.tw/new/collection/2020-10-06/23ac0c3d-89f7-4732-b94d-18b135564779/784e37c4-25cc-4338-9920-db1a8c61562e.jpg",
                symbol_img: "https://i.pinimg.com/736x/29/55/16/2955163a48959f96ea0a3cec8102e554.jpg",
                tattoo_img: "https://placehold.co/100x100/be123c/ffffff?text=太魯閣+紋面",
                festival_img: "https://placehold.co/100x100/7c3aed/ffffff?text=祖靈祭"
            },
            {
                name: "撒奇萊雅族 (Sakizaya)",
                feature: "火神祭，浴火重生。",
                festival: "火神祭 (Palamal)",
                symbol: "火紅與土金",
                tattoo: "無顯著紋面文化。",
                image: "https://www.titic.cip.gov.tw/public/order/1081204000014/image/%E9%99%84%E4%BB%B6%E7%85%A7%E7%89%871.jpg",
                symbol_img: "https://www.nine.com.tw/Templates/108026/images/all/nav_ab_014.jpg",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/991b1c/ffffff?text=火神祭"
            },
            {
                name: "賽德克族 (Seediq)",
                feature: "發源於白石山，重視祖靈與Gaya，為人知曉的霧社事件發生地。",
                festival: "祖靈祭 (Smratuc)",
                symbol: "菱形紋、弓箭紋，菱形紋是祖靈的眼，體現對祖訓Gaya的堅守。",
                tattoo: "【有紋面】男子紋額與下巴，女子紋兩頰，是對Gaya的實踐和成年的標誌。",
                image: "https://channelplus.ner.gov.tw/api/images/5c93260fbe337e0007fff98c/1600/jpeg",
                symbol_img: "https://img.ltn.com.tw/Upload/art/page/800/2022/09/03/4.jpg",
                tattoo_img: "https://placehold.co/100x100/881337/ffffff?text=賽德克+紋面",
                festival_img: "https://placehold.co/100x100/4f46e5/ffffff?text=祖靈祭"
            },
            {
                name: "拉阿魯哇族 (Hla'alua)",
                feature: "原居高雄桃源區，傳說曾與矮人共同生活，獲贈聖貝而有獨特祭典。",
                festival: "聖貝祭 (Miatungusu)",
                symbol: "聖貝",
                tattoo: "無顯著紋面文化。",
                image: "https://news.pchome.com.tw/newsdata/living/7days/20220427/65106158479134295009.jpg",
                symbol_img: "https://pic.pimg.tw/hoelex513/1497246483-2741008818.png",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/047857/ffffff?text=聖貝祭"
            },
            {
                name: "卡那卡那富族 (Kanakanavu)",
                feature: "居住於高雄那瑪夏區，感謝天神與祖靈庇佑小米豐收與平安。",
                festival: "米貢祭 (Mikongu)",
                symbol: "小米、紅藜",
                tattoo: "無顯著紋面文化。",
                image: "https://file.moc.gov.tw/001/Upload/OldFiles/AdminUploads/information/large/f94568eb-746d-4cf8-817f-a3f3d3a91ca5.jpg?0,399,0,224",
                symbol_img: "https://pic.pimg.tw/hoelex513/1497246482-1224245.png",
                tattoo_img: null,
                festival_img: "https://placehold.co/100x100/15803d/ffffff?text=米貢祭"
            }
        ];

        // --- 主元件 ---
        const TaiwanMap = () => {
            const [geoData, setGeoData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedCounty, setSelectedCounty] = useState(null);
            const [hoveredCounty, setHoveredCounty] = useState(null);
            
            const [showTribesModal, setShowTribesModal] = useState(false);
            const [enlargedImage, setEnlargedImage] = useState(null);

            const [question, setQuestion] = useState('');
            const [qnaLoading, setQnaLoading] = useState(false);
            const [historyQnA, setHistoryQnA] = useState([
                { role: 'model', text: '你好！我是你的 AI 歷史導遊。關於這片土地的故事，有什麼想問的嗎？' }
            ]);

            const [scale, setScale] = useState(1);
            const [translate, setTranslate] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            
            const [mode, setMode] = useState('general');
            const [selectedPeriod, setSelectedPeriod] = useState('indigenous');

            const svgRef = useRef(null);
            const containerRef = useRef(null);
            const qnaScrollRef = useRef(null);
            const hasMovedRef = useRef(false);

            const apiKey = ""; // 請填入您的 Gemini API Key

            // --- 函式定義區 (確保在 return 前定義) ---

            const handleZoomIn = () => setScale(s => Math.min(s * 1.5, 5));
            const handleZoomOut = () => setScale(s => Math.max(s / 1.5, 1));
            const handleReset = () => { setScale(1); setTranslate({ x: 0, y: 0 }); setSelectedCounty(null); };

            const handleWheel = (e) => {
                const scaleAdjustment = -e.deltaY * 0.002;
                const newScale = Math.max(0.5, Math.min(10, scale + scaleAdjustment));
                setScale(newScale);
            };

            const handleMouseDown = (e) => {
                setIsDragging(true);
                setDragStart({ x: e.clientX - translate.x, y: e.clientY - translate.y });
                hasMovedRef.current = false;
            };

            const handleMouseMove = (e) => {
                if (isDragging) {
                    const newX = e.clientX - dragStart.x;
                    const newY = e.clientY - dragStart.y;
                    if (!hasMovedRef.current) {
                        const dist = Math.sqrt(Math.pow(newX - translate.x, 2) + Math.pow(newY - translate.y, 2));
                        if (dist > 2) hasMovedRef.current = true;
                    }
                    setTranslate({ x: newX, y: newY });
                }
            };

            const handleMouseUp = () => setIsDragging(false);
            const handleMouseLeave = () => { setIsDragging(false); setHoveredCounty(null); };

            const handleCountyClick = (e, name) => {
                e.stopPropagation();
                if (!hasMovedRef.current) {
                    setSelectedCounty(name === selectedCounty ? null : name);
                    // 移除 setHistoryQnA([]) 以保留對話記錄，提升體驗
                }
            };

            const handleAskLLM = async () => {
                if (!question.trim()) return;
                // 簡單檢查 (實際應用請填入 apiKey)
                if (!apiKey) {
                    setHistoryQnA(prev => [...prev, { role: 'user', text: question }, { role: 'model', text: "請先設定 API Key 才能使用 AI 問答功能。" }]);
                    setQuestion('');
                    return;
                }

                const userQuestion = question;
                setQuestion('');
                setQnaLoading(true);
                setHistoryQnA(prev => [...prev, { role: 'user', text: userQuestion }]);

                const displayCountyName = hoveredCounty || selectedCounty || '全台灣';
                const currentPeriodInfo = historyPeriods.find(p => p.id === selectedPeriod);
                const currentPeriodName = currentPeriodInfo ? currentPeriodInfo.name : '現代';
                
                const contextInfo = `
                  當前使用者狀態：
                  - 正在瀏覽地區：${displayCountyName}
                  - 當前模式：${mode === 'history' ? '歷史發展模式' : '一般地理資訊模式'}
                  - 當前歷史時期焦點：${mode === 'history' ? currentPeriodName : '現代'}
                `;

                const systemPrompt = `你是一位專業、親切且知識淵博的台灣歷史與地理導遊。
                請根據使用者的問題以及當前的瀏覽情境（Context）來回答。
                回答風格要生動有趣，適合大眾閱讀，但歷史事實必須嚴謹。
                請使用繁體中文回答。`;

                const userQuery = `${contextInfo}\n\n使用者的問題是：${userQuestion}`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            tools: [{ "google_search": {} }]
                        })
                    });
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate) {
                        const responseText = candidate.content?.parts?.[0]?.text || "抱歉，我現在無法回答這個問題。";
                        const sources = candidate.groundingMetadata?.groundingAttributions?.map(attr => ({
                            title: attr.web?.title || "資料來源",
                            uri: attr.web?.uri
                        })).filter(s => s.uri) || [];

                        setHistoryQnA(prev => [...prev, { role: 'model', text: responseText, sources: sources }]);
                    } else {
                         setHistoryQnA(prev => [...prev, { role: 'model', text: "API 回應無效，請稍後再試。" }]);
                    }
                } catch (error) {
                    setHistoryQnA(prev => [...prev, { role: 'model', text: "連線發生錯誤，請檢查 API Key 或網路。" }]);
                } finally {
                    setQnaLoading(false);
                }
            };

            const hasHistory = (countyName) => {
                return countyHistory[countyName] && countyHistory[countyName][selectedPeriod] && countyHistory[countyName][selectedPeriod] !== "-";
            };

            // 載入地圖資料
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await fetch('https://unpkg.com/taiwan-atlas/counties-10t.json');
                        const topology = await response.json();
                        const geojson = topojson.feature(topology, topology.objects.counties);
                        setGeoData(geojson);
                        setLoading(false);
                    } catch (error) {
                        console.error("Failed to load map data:", error);
                        setLoading(false);
                    }
                };
                loadData();
            }, []);

            // 自動捲動對話框
            useEffect(() => {
                if (qnaScrollRef.current) {
                    qnaScrollRef.current.scrollTop = qnaScrollRef.current.scrollHeight;
                }
            }, [historyQnA, showTribesModal]);


            // 渲染變數準備
            const displayCounty = hoveredCounty || selectedCounty;
            const currentPeriodInfo = historyPeriods.find(p => p.id === selectedPeriod);
            const displayedCountyData = displayCounty ? (countyData[displayCounty] || {}) : {};
            const displayedCountyHistory = displayCounty ? (countyHistory[displayCounty] || {}) : {};

            // --- 渲染地圖 (Render Map) ---
            const renderMap = () => {
                if (!geoData) return null;
                const projection = d3.geoMercator().center([120.9, 23.7]).scale(8000).translate([300, 350]);
                const pathGenerator = d3.geoPath().projection(projection);
                
                const activeColor = currentPeriodInfo ? currentPeriodInfo.color : '#3b82f6';
                const islandScales = { "澎湖縣": 1.8, "金門縣": 2.2, "連江縣": 3.0 };

                return (
                    <g transform={`translate(${translate.x}, ${translate.y}) scale(${scale})`}>
                        {geoData.features.map((feature, i) => {
                            const rawName = feature.properties.name || feature.properties.COUNTYNAME;
                            const name = normalizeName(rawName);
                            const isSelected = selectedCounty === name;
                            const isHovered = hoveredCounty === name;
                            
                            let fillColor = "#e2e8f0";
                            let strokeColor = "#374151";
                            
                            // 這裡需要用 hasHistory(name)
                            const hasEvent = hasHistory(name);
                            const displayForColor = displayCounty;

                            if (mode === 'history') {
                                if (name === displayForColor) {
                                    fillColor = activeColor;
                                    strokeColor = "#fbbf24";
                                } else if (hasEvent) {
                                    fillColor = `${activeColor}66`;
                                } else {
                                    fillColor = "#f1f5f9";
                                }
                            } else {
                                fillColor = name === displayForColor ? "#3b82f6" : isHovered ? "#93c5fd" : "#e2e8f0";
                            }

                            const islandScale = islandScales[name] || 1;
                            const [cx, cy] = pathGenerator.centroid(feature);
                            // 修正 transform 語法
                            const pathTransform = islandScale > 1 ? `translate(${cx}, ${cy}) scale(${islandScale}) translate(-${cx}, -${cy})` : undefined;
                            const baseStrokeWidth = (mode === 'history' && hasEvent) ? 1.5 : 1;
                            const finalStrokeWidth = baseStrokeWidth / islandScale;

                            return (
                                <path
                                    key={i}
                                    d={pathGenerator(feature)}
                                    fill={fillColor}
                                    stroke={strokeColor}
                                    strokeWidth={finalStrokeWidth}
                                    transform={pathTransform}
                                    className={`transition-colors duration-200 ease-in-out ${isDragging ? 'cursor-grabbing' : 'cursor-pointer'}`}
                                    onMouseEnter={() => !isDragging && setHoveredCounty(name)}
                                    onMouseLeave={() => setHoveredCounty(null)}
                                    onClick={(e) => handleCountyClick(e, name)}
                                />
                            );
                        })}
                    </g>
                );
            };

            return (
                <div className="flex flex-col h-screen w-screen bg-slate-50 font-sans text-slate-800 overflow-hidden relative">
                    {/* Header */}
                    <header className="flex-none bg-white/90 backdrop-blur shadow-sm z-40 relative">
                        <div className="p-4 flex items-center justify-between border-b border-slate-100">
                            <div className="flex items-center gap-2">
                                <MapIcon className={`w-6 h-6 ${mode === 'history' ? 'text-amber-600' : 'text-blue-600'}`} />
                                <h1 className="text-xl font-bold text-slate-800">
                                    {mode === 'history' ? '台灣歷史與文化地圖' : '台灣行政區互動地圖'}
                                </h1>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-lg gap-2">
                                <button onClick={() => { setMode('general'); setSelectedCounty(null); }} className={`px-3 py-1.5 text-sm rounded-md flex items-center gap-2 ${mode === 'general' ? 'bg-white shadow text-blue-600 font-medium' : 'text-slate-500'}`}>
                                    <Info className="w-4 h-4" /> 一般資訊
                                </button>
                                <button onClick={() => { setMode('history'); setSelectedCounty(null); }} className={`px-3 py-1.5 text-sm rounded-md flex items-center gap-2 ${mode === 'history' ? 'bg-white shadow text-amber-600 font-medium' : 'text-slate-500'}`}>
                                    <BookOpen className="w-4 h-4" /> 歷史模式
                                </button>
                                <button onClick={() => setShowTribesModal(true)} className="px-3 py-1.5 text-sm rounded-md flex items-center gap-2 text-slate-500 hover:text-green-700 hover:bg-green-50">
                                    <Users className="w-4 h-4" /> 原住民族 16 族介紹
                                </button>
                            </div>
                        </div>
                        {mode === 'history' && (
                            <div className="px-4 py-3 bg-stone-100 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2 border-b border-stone-200">
                                {historyPeriods.map((period) => {
                                    const PeriodIcon = period.icon;
                                    return (
                                        <button 
                                            key={period.id} 
                                            onClick={() => { setSelectedPeriod(period.id); setSelectedCounty(null); }} 
                                            className={`px-4 py-2 rounded-full text-sm font-medium border flex items-center gap-2 ${selectedPeriod === period.id ? 'text-white shadow-md border-transparent' : 'bg-white text-slate-600 border-slate-200'}`} 
                                            style={{ backgroundColor: selectedPeriod === period.id ? period.color : undefined }}
                                        >
                                            <PeriodIcon className="w-4 h-4" />
                                            <span>{period.name}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </header>

                    {/* Modal */}
                    {showTribesModal && (
                        <div className="absolute inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden relative animate-fadeIn">
                                <div className="bg-green-700 text-white p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-3"><Feather className="w-6 h-6" /><h2 className="text-xl font-bold">台灣原住民族 16 族介紹</h2></div>
                                    <button onClick={() => setShowTribesModal(false)} className="p-1 hover:bg-white/20 rounded-full"><X className="w-6 h-6" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 bg-slate-50 custom-scrollbar">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {tribesData.map((tribe, index) => (
                                            <div key={index} className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                                                <h3 className="text-lg font-bold text-green-800 mb-2 border-b border-green-100 pb-2">{tribe.name}</h3>
                                                {tribe.image && (
                                                    <div className="mb-4 rounded-lg overflow-hidden border border-slate-100 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.image, alt: tribe.name })}>
                                                        <img src={tribe.image} alt={`${tribe.name} 示意圖`} className="w-full h-48 object-cover hover:scale-105 transition-transform duration-500" onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x400/CCCCCC/374151?text=圖片載入失敗"; }} />
                                                    </div>
                                                )}
                                                <div className="space-y-3 text-sm flex-1">
                                                    <div><span className="text-xs font-bold text-slate-400 block mb-1">特色</span><p className="text-slate-700">{tribe.feature}</p></div>
                                                    {tribe.symbol_img && (
                                                        <div className='flex items-start gap-3'>
                                                            <div className="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden border border-slate-300 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.symbol_img, alt: `${tribe.name} 圖騰` })}>
                                                                <img src={tribe.symbol_img} className="w-full h-full object-cover" onError={(e) => { e.target.src="https://placehold.co/100x100/CCCCCC/374151?text=圖騰"; }} />
                                                            </div>
                                                            <div><span className="text-xs font-bold text-slate-400 block mb-1">文化圖騰與意義</span><p className="text-slate-700 font-medium">{tribe.symbol}</p></div>
                                                        </div>
                                                    )}
                                                    {tribe.tattoo_img ? (
                                                        <div className='flex items-start gap-3'>
                                                            <div className="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden border border-slate-300 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.tattoo_img, alt: `${tribe.name} 紋面` })}>
                                                                <img src={tribe.tattoo_img} className="w-full h-full object-cover" onError={(e) => { e.target.src="https://placehold.co/100x100/CCCCCC/374151?text=紋面"; }} />
                                                            </div>
                                                            <div><span className="text-xs font-bold text-slate-400 flex items-center gap-1 mb-1"><Brush className="w-3 h-3 text-red-400"/> 紋面/紋身</span><p className="text-slate-700 italic">{tribe.tattoo}</p></div>
                                                        </div>
                                                    ) : (
                                                        <div><span className="text-xs font-bold text-slate-400 flex items-center gap-1 mb-1"><Brush className="w-3 h-3 text-red-400"/> 紋面/紋身</span><p className="text-slate-700 italic">{tribe.tattoo}</p></div>
                                                    )}
                                                    {tribe.festival_img && (
                                                        <div className='flex items-start gap-3 pt-2 mt-auto'>
                                                            <div className="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden border border-slate-300 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.festival_img, alt: `${tribe.name} 慶典` })}>
                                                                <img src={tribe.festival_img} className="w-full h-full object-cover" onError={(e) => { e.target.src="https://placehold.co/100x100/CCCCCC/374151?text=慶典"; }} />
                                                            </div>
                                                            <div><span className="text-xs font-bold text-slate-400 block mb-1">重要慶典</span><p className="font-medium text-green-600 bg-green-50 px-2 py-1 rounded inline-block">{tribe.festival}</p></div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-6 text-center text-xs text-slate-400">資料來源：原住民族委員會 (CIP) 及相關文化研究</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Enlarged Image */}
                    {enlargedImage && (
                        <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 cursor-zoom-out" onClick={() => setEnlargedImage(null)}>
                            <div className="relative w-full h-full max-w-6xl max-h-[90vh] flex items-center justify-center">
                                <img src={enlargedImage.src} alt={enlargedImage.alt} className="object-contain max-h-full max-w-full rounded-lg shadow-2xl" />
                                <button className="absolute top-4 right-4 text-white p-2 rounded-full bg-black/50 hover:bg-black/70" onClick={() => setEnlargedImage(null)}><X className="w-8 h-8" /></button>
                                <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-lg text-sm">{enlargedImage.alt} - 點擊任意處關閉</div>
                            </div>
                        </div>
                    )}

                    <div className="flex-1 relative overflow-hidden">
                        <div 
                            ref={containerRef}
                            className={`absolute inset-0 transition-colors duration-500 ${mode === 'history' ? 'bg-stone-50' : 'bg-blue-50'} ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
                            onWheel={handleWheel}
                            onMouseDown={handleMouseDown}
                            onMouseMove={handleMouseMove}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseLeave}
                            onTouchStart={() => setIsDragging(true)}
                            onTouchEnd={() => setIsDragging(false)}
                            onClick={() => { if(!hasMovedRef.current) setSelectedCounty(null); }}
                        >
                            {loading ? (
                                <div className="flex items-center justify-center h-full gap-2 text-slate-500 animate-pulse"><Loader2 className="w-6 h-6 animate-spin" /><span>載入地圖資料中...</span></div>
                            ) : (
                                <>
                                    {mode === 'history' && (
                                        <div className="absolute top-4 left-4 p-4 max-w-xs z-0 pointer-events-none select-none">
                                            <h3 className="text-2xl font-bold text-slate-300" style={{ color: `${currentPeriodInfo.color}88` }}>{currentPeriodInfo.name}</h3>
                                            <p className="text-slate-400 text-sm mt-1 font-medium opacity-80">{currentPeriodInfo.year}</p>
                                            <p className="text-slate-500 text-sm mt-2">{currentPeriodInfo.desc}</p>
                                        </div>
                                    )}
                                    <div className="absolute top-4 right-4 bg-white/80 backdrop-blur px-2 py-1 rounded text-xs text-slate-400 pointer-events-none select-none z-0">滾輪縮放 • 拖曳移動</div>
                                    <svg ref={svgRef} viewBox="0 0 600 700" className="w-full h-full drop-shadow-xl z-10 select-none">
                                        <defs><filter id="glow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="2" result="blur" /><feComposite in="SourceGraphic" in2="blur" operator="over" /></filter></defs>
                                        {renderMap()}
                                    </svg>
                                </>
                            )}
                            <div className="absolute bottom-6 left-6 flex flex-col gap-2 bg-white p-2 rounded-lg shadow-lg border border-slate-200 z-10" onMouseDown={(e) => e.stopPropagation()}>
                                <button onClick={handleZoomIn} className="p-2 hover:bg-slate-100 rounded text-slate-600" title="放大"><ZoomIn className="w-5 h-5" /></button>
                                <button onClick={handleZoomOut} className="p-2 hover:bg-slate-100 rounded text-slate-600" title="縮小"><ZoomOut className="w-5 h-5" /></button>
                                <button onClick={handleReset} className="p-2 hover:bg-slate-100 rounded text-slate-600" title="重置視角"><Maximize className="w-5 h-5" /></button>
                            </div>
                        </div>

                        {/* Right Side Panel */}
                        <div className={`absolute top-4 bottom-4 right-4 w-72 bg-white/95 backdrop-blur-md shadow-2xl rounded-2xl border border-white/50 transform transition-transform duration-300 ease-out z-30 flex flex-col overflow-hidden ${displayCounty ? 'translate-x-0' : 'translate-x-[120%]'}`}>
                            {displayCounty && (
                                <div className="h-full flex flex-col">
                                    <div className="p-4 border-b flex justify-between items-center text-white transition-colors duration-300 flex-none" style={{ backgroundColor: mode === 'history' ? currentPeriodInfo.color : '#2563eb' }}>
                                        <h2 className="text-xl font-bold flex items-center gap-2">{displayCounty}{mode === 'history' && <span className="text-xs bg-white/20 px-2 py-1 rounded border border-white/30">{currentPeriodInfo.name}</span>}</h2>
                                        {selectedCounty && <button onClick={() => setSelectedCounty(null)} className="hover:bg-white/20 p-1 rounded transition-colors"><X className="w-5 h-5" /></button>}
                                    </div>
                                    <div className="p-5 space-y-5 overflow-y-auto flex-1 custom-scrollbar">
                                        {/* Q&A */}
                                        <div className="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                            <h4 className="flex items-center gap-2 text-sm font-bold text-yellow-800 mb-3"><MessageSquare className="w-4 h-4" /> ✨ 歷史問答</h4>
                                            <div ref={qnaScrollRef} className="space-y-3 max-h-40 overflow-y-auto mb-3 pr-2">
                                                {historyQnA.map((item, i) => (
                                                    <div key={i} className={`flex ${item.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                        <div className={`max-w-[85%] p-2 rounded-lg text-xs ${item.role === 'user' ? 'bg-blue-200 text-slate-800' : 'bg-white shadow text-slate-700'}`}>
                                                            <p>{item.text}</p>
                                                            {item.sources?.length > 0 && <div className="mt-1 pt-1 border-t border-slate-200 text-[10px] text-slate-500">來源: {item.sources.map((s, si) => <a key={si} href={s.uri} target="_blank" className="block truncate hover:underline">- {s.title}</a>)}</div>}
                                                        </div>
                                                    </div>
                                                ))}
                                                {qnaLoading && <div className="text-xs text-slate-500 animate-pulse">AI 思考中...</div>}
                                            </div>
                                            <div className="flex gap-2">
                                                <input type="text" value={question} onChange={e => setQuestion(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAskLLM()} placeholder={`關於 ${displayCounty}...`} className="flex-1 px-3 py-2 text-sm border rounded-lg" disabled={qnaLoading} />
                                                <button onClick={handleAskLLM} disabled={qnaLoading || !question.trim()} className="p-2 bg-yellow-600 text-white rounded-lg disabled:bg-yellow-400"><Send className="w-4 h-4" /></button>
                                            </div>
                                        </div>

                                        {mode === 'general' ? (
                                            <div className="space-y-4">
                                                <div className="flex items-start gap-3"><div className="p-2 bg-blue-100 text-blue-600 rounded-lg"><Info className="w-5 h-5" /></div><div><p className="text-xs text-slate-500 mb-1">地方特色</p><p className="font-medium text-sm">{displayedCountyData.feature}</p></div></div>
                                                <div className="grid grid-cols-1 gap-3">
                                                    <div className="bg-slate-50 p-3 rounded-lg border"><p className="text-xs text-slate-500 mb-1">人口</p><p className="font-semibold">{displayedCountyData.population}</p></div>
                                                    <div className="bg-slate-50 p-3 rounded-lg border"><p className="text-xs text-slate-500 mb-1">面積</p><p className="font-semibold">{displayedCountyData.area}</p></div>
                                                </div>
                                                <button onClick={() => setMode('history')} className="w-full py-2 bg-stone-100 text-stone-700 rounded-lg text-xs font-medium hover:bg-stone-200 flex justify-center gap-2"><BookOpen className="w-4 h-4" /> 查看歷史發展</button>
                                            </div>
                                        ) : (
                                            <div className="space-y-5 animate-fadeIn">
                                                <div className="p-4 rounded-xl border bg-opacity-10 border-opacity-20" style={{ backgroundColor: `${currentPeriodInfo.color}11`, borderColor: currentPeriodInfo.color }}>
                                                    <div className="flex items-center gap-2 mb-3" style={{ color: currentPeriodInfo.color }}>{currentPeriodInfo.icon}<h3 className="font-bold text-sm">{currentPeriodInfo.name} ({currentPeriodInfo.year})</h3></div>
                                                    <div className="text-slate-700 leading-relaxed font-medium text-sm">
                                                        {displayedCountyHistory[selectedPeriod] && displayedCountyHistory[selectedPeriod] !== "-" ? displayedCountyHistory[selectedPeriod] : <span className="text-slate-400 italic text-xs">此時期該區域尚無重大開發紀錄。</span>}
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider px-1">該地區歷史軌跡</h4>
                                                    <div className="relative border-l-2 border-slate-100 ml-2 space-y-4 pb-2">
                                                        {historyPeriods.map(period => {
                                                            if (period.id === selectedPeriod) return null;
                                                            const txt = countyHistory[displayCounty]?.[period.id];
                                                            if (!txt || txt === "-") return null;
                                                            return (
                                                                <div key={period.id} className="relative pl-5 group cursor-pointer" onClick={() => { setSelectedPeriod(period.id); setSelectedCounty(null); }}>
                                                                    <div className="absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full border-2 border-white" style={{ backgroundColor: period.color }}></div>
                                                                    <div className="mb-1"><span className="text-xs font-bold" style={{ color: period.color }}>{period.name}</span></div>
                                                                    <p className="text-xs text-slate-500 line-clamp-2 hover:line-clamp-none">{txt}</p>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <TaiwanMap />
            </ErrorBoundary>
        );
    </script>
</body>
</html>

