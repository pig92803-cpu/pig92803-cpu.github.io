<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣歷史與文化地圖</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- D3 & TopoJSON -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        .cursor-zoom-in { cursor: zoom-in; }
        .cursor-zoom-out { cursor: zoom-out; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen flex items-center justify-center bg-gray-100 text-gray-500">
        <div class="text-center">
            <h2 class="text-xl font-bold mb-2">正在載入地圖應用程式...</h2>
            <p class="text-sm">初始化中，請稍候。</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. 錯誤捕捉元件 ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-10 text-red-600">
                            <h1 className="text-2xl font-bold">應用程式發生錯誤</h1>
                            <p>這可能是程式碼語法或執行順序的問題。</p>
                            <pre className="mt-4 bg-red-50 p-4 rounded border border-red-200 text-sm overflow-auto">{this.state.error.toString()}</pre>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- 2. SVG 圖標元件定義 (放在最外層，避免依賴順序問題) ---
        const Icon = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const MapIcon = (props) => <Icon {...props}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" /><line x1="8" y1="2" x2="8" y2="18" /><line x1="16" y1="6" x2="16" y2="22" /></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>;
        const ZoomIn = (props) => <Icon {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></Icon>;
        const ZoomOut = (props) => <Icon {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></Icon>;
        const Maximize = (props) => <Icon {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" /></Icon>;
        const BookOpen = (props) => <Icon {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></Icon>;
        const ChevronRight = (props) => <Icon {...props}><polyline points="9 18 15 12 9 6" /></Icon>;
        const Feather = (props) => <Icon {...props}><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z" /><line x1="16" y1="8" x2="2" y2="22" /><line x1="17.5" y1="15" x2="9" y2="15" /></Icon>;
        const Sword = (props) => <Icon {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" /><line x1="13" y1="19" x2="19" y2="13" /><line x1="16" y1="16" x2="20" y2="20" /><line x1="19" y1="21" x2="21" y2="19" /></Icon>;
        const Move = (props) => <Icon {...props}><polyline points="5 9 2 12 5 15" /><polyline points="9 5 12 2 15 5" /><polyline points="15 19 12 22 9 19" /><polyline points="19 9 22 12 19 15" /><line x1="2" y1="12" x2="22" y2="12" /><line x1="12" y1="2" x2="12" y2="22" /></Icon>;
        const Users = (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></Icon>;
        const Brush = (props) => <Icon {...props}><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08" /><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2.5 2.24 0 .46.48.8.97.8 2.52 0 5-2.53 5-5.06 0-.83-.47-1-1.03-1z" /></Icon>;
        const Send = (props) => <Icon {...props}><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></Icon>;
        const Loader2 = (props) => <Icon {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;

        const normalizeName = (name) => name ? name.replace(/台/g, '臺') : "";

        // --- 3. 靜態數據資料庫 ---
        const countyData = {
            "臺北市": { population: "2,504,000 (2024年)", area: "271.80 km²", feature: "首都、台北101、故宮博物院、大稻埕、陽明山國家公園" },
            "新北市": { population: "4,040,000", area: "2,052.57 km²", feature: "耶誕城、淡水老街、九份山城" },
            "桃園市": { population: "2,320,000", area: "1,220.95 km²", feature: "國際機場、大溪豆干、石門水庫" },
            "臺中市": { population: "2,850,000", area: "2,214.90 km²", feature: "逢甲夜市、國家歌劇院、高美濕地" },
            "臺南市": { population: "1,860,000", area: "2,191.65 km²", feature: "赤崁樓、安平古堡、牛肉湯、美食之都" },
            "高雄市": { population: "2,730,000", area: "2,951.85 km²", feature: "愛河、駁二藝術特區、高雄港、流行音樂中心" },
            "基隆市": { population: "360,000", area: "132.76 km²", feature: "廟口夜市、潮境公園、郵輪母港" },
            "新竹市": { population: "456,000", area: "104.15 km²", feature: "科學園區、城隍廟、巨城購物中心" },
            "嘉義市": { population: "263,000", area: "60.03 km²", feature: "火雞肉飯、檜意森活村、管樂節" },
            "新竹縣": { population: "590,000", area: "1,427.54 km²", feature: "客家文化、內灣老街、六福村" },
            "苗栗縣": { population: "534,000", area: "1,820.31 km²", "feature": "龍騰斷橋、勝興車站、大湖草莓" },
            "彰化縣": { population: "1,240,000", area: "1,074.40 km²", feature: "八卦山大佛、鹿港老街、肉圓" },
            "南投縣": { population: "477,000", area: "4,106.44 km²", feature: "日月潭、清境農場、玉山登山口" },
            "雲林縣": { population: "660,000", area: "1,290.83 km²", feature: "劍湖山世界、北港朝天宮、布袋戲" },
            "嘉義縣": { population: "485,000", area: "1,903.64 km²", feature: "阿里山小火車、故宮南院、高跟鞋教堂" },
            "屏東縣": { population: "795,000", area: "2,775.60 km²", feature: "墾丁國家公園、東港黑鮪魚、小琉球" },
            "宜蘭縣": { population: "450,000", area: "2,143.63 km²", feature: "礁溪溫泉、太平山、三星蔥" },
            "花蓮縣": { population: "317,000", area: "4,628.57 km²", feature: "太魯閣峽谷、七星潭、瑞穗牧場" },
            "臺東縣": { population: "211,000", area: "3,515.25 km²", feature: "鹿野高台熱氣球、伯朗大道、三仙台" },
            "澎湖縣": { population: "108,000", area: "126.86 km²", feature: "澎湖花火節、雙心石滬、玄武岩" },
            "金門縣": { population: "143,000", area: "151.66 km²", feature: "高粱酒、風獅爺、戰地坑道" },
            "連江縣": { population: "14,000", area: "28.80 km²", feature: "藍眼淚、芹壁聚落、北海坑道" },
        };

        const countyHistory = {
   　　　　　"臺南市": { indigenous: "【西拉雅族 Siraya - 祀壺與平原之魂】我們是嘉南平原最早的定居者，擁有母系社會的溫柔與強韌。在荷蘭文獻中，我們是「福爾摩沙人」的原型。儘管經歷長期的政權殖民與漢化衝擊，導致語言瀕臨斷層，但我們透過「阿立祖（Alid）」的祀壺信仰與大內、東山的夜祭（Ta-ai），頑強地保存了族群靈魂。今日，透過語言復振與正名運動，我們正重新編織失落的西拉雅語法，向祖靈宣告我們的存在。", dutch: "【政治中心】荷蘭建立熱蘭遮城(安平)與普羅民遮城(赤崁)，後為鄭氏政權首都「東都」。", qing: "【一府】設台灣府，為全台政治經濟中心，五條港商業繁榮。", resistance: "【噍吧哖事件】1915年余清芳於西來庵密謀起義，在玉井地區爆發大規模武裝抗爭，為規模最大的抗日事件。", japanese: "【糖業重鎮】設立糖業試驗所，推動現代化製糖；台南州廳落成。", modern: "【文化古都與南科】南部科學園區帶動半導體產業，同時致力於古蹟保存。" },
            "新北市": { indigenous: "【凱達格蘭與泰雅 - 流動與堅守】在盆地邊緣與北海岸，凱達格蘭族（Ketagalan）曾駕獨木舟穿梭於河流與海洋，但我們的身影多已消融於漢人社會，僅留地名為證。而在烏來山區，泰雅族（Atayal）嚴守「Gaga」祖訓，透過織布與紋面傳承榮耀。我們曾為捍衛獵場與樟腦資源，與入侵的隘勇線進行長達百年的游擊對抗。", dutch: "【西班牙據點】西班牙人於淡水建立聖多明哥城(紅毛城前身)，後被荷蘭人擊退。", qing: "【開港通商】淡水開港，茶葉與樟腦出口大增；金瓜石、九份發現金礦。", resistance: "【簡大獅】抗日三猛之一，於大屯山區一帶進行游擊戰，雖一度歸順但最終仍遭處決。", japanese: "【礦業興盛】瑞芳、平溪煤礦與金礦產業發達，帶動鐵道建設。", modern: "【衛星城市】隨著台北都會區擴張，發展成全台人口最多的直轄市。" },
            "基隆市": { indigenous: "【巴賽族 Basay - 偉大的航海者】作為凱達格蘭的一支，我們是北台灣最強大的海洋貿易中介者。我們的祖先不從事大規模農業，而是以精湛的操舟技術，往來於河流與海洋之間，交換硫磺、黃金與外來貨物。和平島曾是我們與國際勢力交會的舞台，我們的血液流淌著海洋的開放與冒險。", dutch: "【聖薩爾瓦多城】西班牙人於和平島建立堡壘，為最早的國際貿易據點之一。", qing: "【雞籠開港】劉銘傳建設基隆港，修築鐵路起點。", resistance: "【乙未首戰】1895年日軍於澳底登陸後，基隆獅球嶺砲台發生激烈戰鬥。", japanese: "【台灣玄關】日本將基隆建設為現代化軍商兩用港，台灣與日本間的主要門戶。", modern: "【港都轉型】發展郵輪觀光與海洋文化產業。" },
            "臺北市": { indigenous: "【凱達格蘭族 Ketagalan - 隱沒的沼澤王者】「艋舺（Banka）」意為獨木舟，「北投（Patauw）」意為女巫。這些地名是我們曾在這片大湖沼澤中生活的證據。隨漢人移墾，我們被迫放棄土地或通婚融合。今日，我們透過凱達格蘭文化館與歷史考據，在水泥叢林中喚醒這座城市原本屬於南島語族的記憶。", dutch: "【早期開發】荷蘭人曾至北投採硫磺。", qing: "【建城與現代化】晚期建立台北城，劉銘傳推動電燈、鐵路等現代化建設。", resistance: "【六氏先生】芝山岩事件，抗日義軍襲擊芝山岩學堂，殺害六名日本教師。", japanese: "【政經中心】總督府(今總統府)、博物館、公園等現代都市計畫實施地。", modern: "【國際都會】信義計畫區開發、台北101完工，台灣金融商業核心。" },
            "高雄市": { indigenous: "【山海交織的族群光譜】在平原，馬卡道族（Makatao）曾居住於刺竹環繞的「Takau（打狗）」部落，因漢化而導致祭儀流失，近年正積極復興夜祭。在深山，卡那卡那富（Kanakanavu）與拉阿魯哇（Hla'alua）族敬畏自然，透過米貢祭與聖貝祭維持宇宙秩序。我們見證了從刺竹林到重工業城的劇烈變遷。", dutch: "【打狗漁村】荷蘭人主要在此進行漁業活動。", qing: "【打狗開港】開港通商後，外商聚集旗後，設領事館與海關。", resistance: "【林少貓】抗日三猛之一，勢力範圍在鳳山、潮州一帶，長期與日軍對峙，後遭日軍誘殺。", japanese: "【南進基地】大規模築港工程，發展重工業與軍事基地，城市快速擴張。", modern: "【工業轉型】石化重工重鎮，近年轉型發展高科技產業與亞洲新灣區。" },
            "彰化縣": { indigenous: "【巴布薩族 Babuza - 大肚王國的餘暉】我們曾是跨部落聯盟「大肚王國（Middag）」的核心力量，由「白晝之王（Lelien）」統治，曾強悍地拒絕荷蘭人與鄭氏的臣服要求。然而，清代的漢人移民潮瓦解了我們的領域，導致族人四散或遷徙至埔里。我們是台灣原住民史上，最具政治組織雛形的傳奇。", dutch: "【半線社】荷蘭時期已有傳教紀錄。", qing: "【二鹿】鹿港成為台灣第二大城，商業極度繁榮；發生林爽文事件。", resistance: "【八卦山之役】乙未戰爭中最大規模的正面會戰，吳湯興、吳彭年等義軍領袖在此壯烈犧牲。", japanese: "【米倉】濁水溪沖積扇的農業開發，扇形車庫建設。", modern: "【精密機械】發展中小企業、花卉種植與精密機械產業。" },
            "南投縣": { indigenous: "【中央山脈的守護者】這裡是台灣的心臟，泰雅、賽德克、布農、邵族在此交會。邵族在日月潭逐白鹿而居；布農族在玉山下傳唱八部合音。而賽德克族人，為了維護「Gaya」的律法與尊嚴，在莫那魯道帶領下發動了霧社事件，選擇走上彩虹橋，也不願在異族的壓迫下苟活。這是台灣原住民抵抗史詩中最悲壯的一頁。", dutch: "-", qing: "【內山開發】漢人逐漸進入埔里盆地開墾，與原住民接觸頻繁。", resistance: "【霧社事件】1930年莫那魯道率領賽德克族人起義，反抗日本高壓統治，震驚國際。", japanese: "【日月潭水力】建設日月潭水力發電所，提供全台工業動力。", modern: "【觀光大縣】921震災後重建，清境、日月潭為國際級景點。" },
            "屏東縣": { indigenous: "【排灣與魯凱 Paiwan & Rukai - 太陽之子與百步蛇】在大武山的懷抱中，我們建立了嚴謹的貴族階級制度。魯凱族的百合花飾象徵純潔與英勇；排灣族的陶壺、琉璃珠與青銅刀記載著祖先的榮耀。面對外來衝擊，我們展現了高度的政治智慧與勇氣：1867年「羅妹號事件」，大頭目卓杞篤與美國官員簽訂《南岬之盟》，在國際法上確立了我們的領土主權；1874年「牡丹社事件」，我們據守石門天險，以原始武力對抗日本近代化軍隊，誓死捍衛家園尊嚴。", dutch: "【探金傳說】荷蘭人曾至瑯嶠(恆春)探金。", qing: "【羅妹號與牡丹社】1867年3月，美籍商船羅發號（Rover）船員誤闖瑯𤩝十八社領土，被視為侵略者遭處決；美軍發動福爾摩沙遠征報復卻遭伏擊失敗，後簽訂《南岬之盟》。1874年日本藉口琉球漂民遇害發動「牡丹社事件」攻台，排灣族人據石門天險浴血抵抗，頭目阿祿古父子壯烈犧牲。此役迫使清廷派沈葆楨來台，轉為積極「開山撫番」並修築恆春古城。", resistance: "【步月樓之役】六堆客家義軍於佳冬步月樓與日軍激戰，為乙未戰爭南部重要戰役。", japanese: "【熱帶農業】發展瓊麻、鳳梨產業，日本移民村設立。", modern: "【國境之南】墾丁國家公園成立，發展觀光與精緻農業。" },
            "雲林縣": { indigenous: "【洪雅族 Hoanya - 消失的鹿場】這片廣袤的平原曾是鹿群奔馳的獵場。洪雅族人在此過著漁獵耕種的生活。然而，隨著漢人移民的墾殖與水利設施的興建，原本的生態環境巨變，我們被迫漢化或遷徙。這片土地的農業繁榮，是建立在我們族群消失的代價之上。", qing: "【設縣】光緒年間正式設縣，但治所不穩。", resistance: "【鐵國山】柯鐵虎（抗日三猛）於古坑大坪頂據險稱王，號稱「鐵國山」，進行長期游擊戰。", japanese: "【製糖】虎尾糖廠設立，成為「糖都」。", modern: "【農業首都】全台最大農業生產地，六輕工業區進駐。" },
            "桃園市": { indigenous: "【泰雅族 Atayal - 山林與隘勇線的對峙】復興區是泰雅族大嵙崁群的領域。我們堅信「Gaga」的規範，臉上的紋面是通過考驗的印記。清代與日治時期，為了掠奪樟腦資源，殖民者修築「隘勇線」並通電網封鎖我們。我們的抗爭不是為了領土，而是為了守護祖靈安息的森林。", qing: "【水利建設】霄裡大圳開鑿，帶動台地農業發展。", resistance: "【龍潭與安平鎮之役】乙未戰爭中，客家義軍利用埤塘地形伏擊日軍，為北台灣重要戰場。", japanese: "【大圳完工】桃園大圳完工，改善灌溉；大溪老街商業繁榮。", modern: "【國門之都】桃園國際機場啟用，吸納大量工業區與移民。" },
            "苗栗縣": { indigenous: "【賽夏族 Saisiyat - 矮靈祭的誓約】我們居住在蓬萊與南庄的雲霧之間。每兩年舉辦的「巴斯達隘（Pas-ta'ai）」，是為了紀念與傳說中矮黑人（Ta'ay）的恩怨與契約。這不僅是祭典，更是歷史的展演，提醒我們謹守信義與和平。這份對無形誓約的堅持，是我們賽夏族最獨特的文化資產。", qing: "【開墾】漢人拓墾淺山地帶，樟腦產業發達。", resistance: "【苗栗事件】1913年羅福星密謀抗日被捕，大量志士犧牲，為同盟會影響下的抗日事件。", japanese: "【石油發現】出磺坑發現亞洲第一口油井。", modern: "【慢城生活】推動三義木雕與客家文化觀光。" },
            "新竹市": { indigenous: "【道卡斯族 Taokas - 竹塹的鹿皮貿易】「竹塹（Pocaal）」原意指海邊。我們曾是強大的道卡斯族竹塹社，透過鹿皮貿易與荷蘭人、漢人建立緊密關係。雖然我們的血統已融入漢人家族，但「竹塹」這個名字，永遠銘刻著我們作為北台灣早期貿易中心的歷史。", qing: "【竹塹城】北台灣最早的行政中心，築有磚石城牆。", resistance: "【牛埔山之役】乙未戰爭中，抗日義軍與日軍近衛師團激戰，有傳言北白川宮能久親王在此受傷。", japanese: "【玻璃工業】發現天然氣與矽砂，發展玻璃產業。", modern: "【台灣矽谷】新竹科學園區成立，全球半導體重鎮。" },
            "新竹縣": { indigenous: "【泰雅與賽夏 - 尖石五峰的古老靈魂】在尖石與五峰的高聳山脈中，泰雅族與賽夏族依山而居。我們是「司馬庫斯（Smangus）」上帝部落的守護者，也是霞喀羅古道上抵抗日本理蕃政策的戰士。這裡的巨木群見證了我們與自然共存的智慧，以及為保衛生存空間所流下的鮮血。", dutch: "-", qing: "【金廣福】北埔姜家設立金廣福墾號，進行武裝拓墾。", resistance: "【北埔事件】1907年發生的抗日事件，為客家人與賽夏族合作抗日。", japanese: "【茶葉與林業】內灣支線鐵路運送木材與煤礦，客家茶產業興盛。", modern: "【科技聚落】竹北發展迅速，成為高科技人才聚落。" },
            "嘉義市": { indigenous: "【洪雅族 Hoanya - 諸羅山的記憶】「諸羅山（Tirosen）」曾是洪雅族諸羅山社的居住地。我們在平原上建立了繁榮的聚落。雖然後來漢人大量移入，將這裡改造成他們的城市，但這座城市的古名，始終記錄著我們曾經存在的事實。", qing: "【嘉義賜名】原名諸羅，因林爽文事件中居民協助清軍，乾隆賜名「嘉義」。", resistance: "【大莆林之役】(嘉義大林) 乙未戰爭中日軍遭遇頑強抵抗，日軍指揮官甚至下令焚庄。", japanese: "【林業樞紐】阿里山林業鐵路起點，木材集散地，稱「木材之都」。", modern: "【觀光消費】服務阿里山觀光客，以管樂節聞名。" },
            "嘉義縣": { indigenous: "【鄒族 Tsou - 庫巴與戰祭的榮耀】阿里山不僅是風景區，更是鄒族人的聖山。男子會所「庫巴（Kuba）」是部落政治與教育的核心，嚴禁女性進入。我們透過神聖的「戰祭（Mayasvi）」，祭祀天神與戰神，祈求部落力量與團結。我們是高山上的斯巴達，以嚴謹的紀律守護傳統領域。", dutch: "-", qing: "【笨港】早期重要港口。", resistance: "-", japanese: "【登山鐵道】阿里山森林鐵路完工。", modern: "【故宮南院】設有故宮南院，發展精緻農業。" },
            "臺中市": { indigenous: "【拍瀑拉族 Papora - 消失的王國與大肚社】我們是「大肚王國」的核心族群，曾展現出驚人的跨部落統治能力。即使面對清朝軍隊的掃蕩（如大甲西社事件），我們仍頑強抵抗。從大肚山到海岸線，我們失去土地後被迫遷往埔里等地，透過「牽田」儀式，我們在流離中追憶祖先奔跑在原野的自由。", qing: "【霧峰林家】台灣五大家族之一，協助平定太平天國與戴潮春事件。", resistance: "-", japanese: "【市區改正】棋盤式街道規劃，台中車站落成。", modern: "【精密機械】中部科學園區，台灣機械產業重鎮。" },
            "宜蘭縣": { indigenous: "【噶瑪蘭族 Kavalan - 平原的失落與重生】「Kavalan」意為平原的人類。我們曾自在地生活在蘭陽平原，直到漢人吳沙入墾，利用「結首制」步步進逼。為了生存，我們被迫展開悲壯的「加禮宛大遷移」，遠走花蓮與台東海岸。2002年，我們終於正名成功，告訴世界：噶瑪蘭族沒有消失，我們回來了。", qing: "【開蘭】吳沙入墾，設噶瑪蘭廳。", resistance: "-", japanese: "【太平山林業】開發太平山林場，羅東成為木材集散地。", modern: "【環保與觀光】童玩節、綠色博覽會，雪隧通車後融入台北生活圈。" },
            "花蓮縣": { indigenous: "【泛靈論的沃土】這是阿美、太魯閣、撒奇萊雅、布農族共存的土地。阿美族的豐年祭（Ilisin）讚頌土地的豐饒；太魯閣族（Truku）承襲泰雅血脈，紋面守護彩虹橋的約定。撒奇萊雅族（Sakizaya）在「加禮宛事件」遭清軍屠殺後，隱姓埋名於阿美族中百年，直到近年才透過「火神祭」洗淨歷史傷痛，重現世人眼前。", qing: "【開山撫番】羅大春開闢北路（蘇花古道）。", resistance: "【七腳川事件】1908年阿美族七腳川社反抗日本勞役，遭日軍鎮壓並強迫遷社。", japanese: "【吉野移民村】日本建立的規模最大移民村（今吉安鄉）。", modern: "【東部大港】花蓮港擴建，觀光產業發達。" },
            "臺東縣": { indigenous: "【南島文化的活博物館】蘭嶼的達悟族（Tao）擁有獨特的飛魚季與拼板舟文化，展現海洋民族的極致適應。卑南族（Puyuma）以嚴謹的會所制度與斯巴達式的「猴祭」訓練少年。布農族自中央山脈遷徙而來。這裡的每個部落，都以強韌的生命力，在山海之間維繫著古老的南島傳統。", qing: "【後山開發】設卑南廳。", resistance: "【麻豆欄事件】早期漢人與平埔族反抗清廷事件。抗日部分有布農族的大分事件(延續至1933年)。", japanese: "【製糖與移民】設立製糖會社與移民村。", modern: "【史前文化】發現卑南遺址（史前最大聚落），熱氣球嘉年華。" },
            "澎湖縣": { indigenous: "【史前海洋的中繼站】早在漢人定居之前，澎湖群島就是史前南島語族航行於台灣海峽的重要中繼站。雖然沒有特定族群長期定居的文字信史，但島上豐富的粗繩紋陶文化遺址，證明了四千年前就有頻繁的海洋移動與漁獵活動，見證了早期人類跨海遷徙的勇氣。", dutch: "【荷蘭前哨】荷蘭人最早於1622年築城。", qing: "【海防重地】中法戰爭孤拔艦隊佔領澎湖。", resistance: "【林獻堂請願】(非武裝) 雖然武裝較少，但澎湖為日軍攻台首站。", japanese: "【軍事要塞】馬公港建設，日本海軍重要基地。", modern: "【觀光島嶼】跨海大橋完工，花火節帶動旅遊。" },
            "金門縣": { indigenous: "-", dutch: "【鄭氏據點】鄭成功伐台基地。", qing: "【僑鄉】大量人口下南洋。", resistance: "-", japanese: "【日軍佔領】二戰末期遭日軍佔領。", modern: "【戰地前線】古寧頭大捷、八二三砲戰，現發展戰地觀光。" },
            "連江縣": { indigenous: "-", dutch: "-", qing: "【漁業基地】閩東漁民定居。", resistance: "-", japanese: "-", modern: "【馬祖戰地】軍事據點，現以藍眼淚聞名。" },
        };

        const historyPeriods = [
            { id: 'indigenous', name: '原住民族', year: '遠古 - 現代', desc: '土地最早的主人，南島語族的智慧、傳說與部落核心價值', color: '#16a34a', icon: Feather },
            { id: 'dutch', name: '荷西與鄭氏', year: '1624 - 1683', desc: '大航海時代的貿易據點與東寧王國的建立', color: '#d97706', icon: MapIcon },
            { id: 'qing', name: '清治時期', year: '1683 - 1895', desc: '渡台禁令鬆綁、開港通商與建省', color: '#059669', icon: Clock },
            { id: 'resistance', name: '抗日行動', year: '1895 - 1915', desc: '乙未戰爭、三猛抗日與武裝革命事件', color: '#b91c1c', icon: Sword },
            { id: 'japanese', name: '日治建設', year: '1895 - 1945', desc: '現代化基礎建設、鐵路與產業開發', color: '#be123c', icon: Clock },
            { id: 'modern', name: '戰後與現代', year: '1945 - 至今', desc: '經濟奇蹟、科技產業轉型與民主化', color: '#2563eb', icon: Info },
        ];

        const tribesData = [
            {
                name: "阿美族 (Amis)",
                feature: "是目前台灣人口最多的原住民族，母系社會，阿美族基本的信仰為太陽，太陽也被稱為「ina」是母親之意。",
                festival: "豐年祭 (Ilisin)",
                symbol: "八角星，代表太陽，象徵宇宙星辰與母親的力量。",
                tattoo: "無紋面文化、鑿齒習俗，有穿耳文化。",
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Indigenous_group_dancers_at_Amis_Music_Festival_2016_IMF0936.jpg/1200px-Indigenous_group_dancers_at_Amis_Music_Festival_2016_IMF0936.jpg",
                symbol_img: "https://i.pinimg.com/736x/58/49/18/584918e4c0452d65f53377f6ede5eb5d.jpg",
                tattoo_img: null,
                festival_img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiTrV8eYXQ9KUGH9us9IWamd4rwXrFfP6Bw6Q86It6J6wnkMzxRtikpgv0K9lvoGGKWwJidkjxb7kLoELlF-YoUPXxwLPRzVrQSeoscHHxrx2C-vbcwy4ozLPFVgndpbNkH3048amUbSqHV/s400/5818-512002.jpg"
            },
            {
                name: "泰雅族 (Atayal)",
                feature: "是目前台灣人口第三多的原住民族。父系社會，深信祖靈信仰 (Utux)，嚴守祖訓 Gaga，只有品德與織布或狩獵能力良好、且有紋面者，死後才可跨越彩虹橋去永生世界。 ",
                festival: "祖靈祭 (Mahal Sminhu)",
                symbol: "菱形紋 (祖靈之眼)、橫條紋（彩虹橋的道路）",
                tattoo: "有紋面文化，象徵成年與英勇，也有鑿齒、穿耳文化。",
                image: "https://s.newtalk.tw/album/news/119/5ab3a2cd1c020.jpg",
                symbol_img: "https://i.ytimg.com/vi/L9u6ZTchsHw/sddefault.jpg",
                tattoo_img: "https://plahan.com.tw/wp-content/uploads/2024/09/1726714649800.jpg",
                festival_img: "https://cecfun.ntsu.edu.tw/var/file/11/1011/img/321481009.png"
            },
            {
                name: "排灣族 (Paiwan)",
                feature: "是台灣人口第二多的原住民族。貴族社會，階級制度嚴謹，工藝精湛，另有石板屋建築。視百步蛇為祖先、守護神。",
                festival: "五年祭 (Maleveq)",
                symbol: "百步蛇紋、人像紋、太陽紋",
                tattoo: "有紋手文化，貴族專屬紋樣代表不同階級的等級，也有染齒、穿耳文化。",
                image: "https://epaper.naer.edu.tw/storage/img/edm_237_4065_img_0.jpg", 
                symbol_img: "https://i.pinimg.com/736x/dd/08/fe/dd08fe2802f33f4e614e3b9aaa0f3c43.jpg",
                tattoo_img: "https://img.ltn.com.tw/Upload/news/600/2011/02/18/185.jpg",
                festival_img: "https://www.zztaitung.com/wp-content/uploads/2019/09/%E3%80%90365%E6%97%A5%E3%80%91No297-11_%E5%8F%B0%E6%9D%B1%E5%8E%9F%E4%BD%8F%E6%B0%91_%E9%81%94%E4%BB%81%E9%84%89_%E4%BA%94%E5%B9%B4%E7%A5%AD_%E6%8E%92%E7%81%A3%E6%97%8F_%E7%A6%8F%E7%90%83_%E5%82%B3%E7%B5%B1%E7%A5%AD%E5%84%80_%E7%A5%88%E7%A6%8F_%E7%A5%96%E9%9D%88_%E7%A5%AD%E7%A5%9E.jpg"
            },
            {
                name: "布農族 (Bunun)",
                feature: "相信萬物皆有靈的精靈（Hanitu）信仰，以「八部合音」聞名國際，另外，殺害黑熊是禁忌。",
                festival: "射耳祭 (Malahtangia)",
                symbol: "棋盤式菱形紋（謠傳靈感來自百步蛇紋）不同於排灣族的「祖先」概念，布農族視百步蛇為「朋友(kaviaz)」",
                tattoo: "無紋面習俗，但有穿耳與鑿齒文化。",
                image: "https://www.ysnp.gov.tw/FileDownload/ContentManagement/20200830013134984809543.jpg",
                symbol_img: "https://ihc.cip.gov.tw/ihcfile/EJournals/44/Content/P121_0003.jpg",
                tattoo_img: "https://www.merit-times.com.tw/news_pic/20220805/C20220804214652277.jpg",
                festival_img: "https://data.boch.gov.tw/upload/representImageFile/2021-07-20/4ea9bf79-ea1d-4e83-af23-14c442eeb51e/%E6%B0%91%E4%BF%9702_%E5%B8%83%E8%BE%B2%E6%97%8F_%E5%B0%84%E8%80%B3%E7%A5%AD-%E6%B0%B8%E4%BF%9D.jpg"
            },
            {
                name: "卑南族 (Puyuma)",
                feature: "認為四處都存在著神靈（biruwa），會所制度、年齡階級嚴謹。",
                festival: "年祭，包含猴祭、大獵祭、除喪",
                symbol: "花朵、十字、人像紋",
                tattoo: "無紋面文化，但有染齒、穿耳文化。",
                image: "https://dcm.s3.hicloud.net.tw/new/collection/2020-10-06/e0d2b47b-996e-4394-bbb0-bc2a71e55570/6ac2e235-a321-4ec4-a2a8-a7642c1678a8.jpg",
                symbol_img: "https://img.yec.tw/cl/api/res/1.2/FBAMWJUOrK38HGidf5su3w--/YXBwaWQ9eXR3YXVjdGlvbnNlcnZpY2U7aD03MDA7cT04NTtyb3RhdGU9YXV0bzt3PTUyNQ--/https://img.yec.tw/ob/image/46a9f84f-fa57-4704-8f0d-eef3a6cb5bc7.jpg",
                tattoo_img: null,
                festival_img: "https://s.yimg.com/ny/api/res/1.2/42zaSOmix0gymPrCekEx_w--/YXBwaWQ9aGlnaGxhbmRlcjt3PTY0MDtoPTUxNg--/https://media.zenfs.com/zh_hant_tw/News/bcc/520037abf8_ww_20131231_180000.jpg"
            },
            {
                name: "魯凱族 (Rukai)",
                feature: "以泛靈信仰為基礎，視百步蛇為神聖的守護神，認為其是部落的起源之一，也是權力和尊貴的象徵。特色也包含百合花飾、石板屋。",
                festival: "小米收穫祭",
                symbol: "百步蛇紋、百合花",
                tattoo: "有紋手文化，貴族女性手紋。",
                image: "https://tcmbdata.culture.tw/api/collection/image/Culture_People?uid=488269",
                symbol_img: "https://imageproxy.pixnet.cc/imgproxy?url=https://pic.pimg.tw/matana/1340769288-1337378247.jpg&ver=20250714",
                tattoo_img: "https://www.ntdtv.com.tw/public/uploads/assets/2018/07/16/2018-07-16-5b4cb2748929f.jpg",
                festival_img: "https://jazko.com/wp-content/uploads/2018/08/3-7.jpg"
            },
            {
                name: "鄒族(Tsou) ",
                feature: "鄒族信仰中，最高的神明是管理天地的哈默（Hamo）大神，也有粟神、稻神、土地神、軍神、天花神等各種不同領域的神（hitsu）。另有類似斯巴達式的男子會所 Kuba，教導少年男性狩獵與生存技巧。",
                festival: "戰祭 (Mayasvi)",
                symbol: "帶有藍、紅、黑、白顏色，與三角形圖案",
                tattoo: "無紋面文化，有鑿齒、穿耳文化。",
                image: "https://channelplus.ner.gov.tw/api/images/5c90b51bbe337e0007ff35b0/1600/jpeg",
                symbol_img: "https://i.pinimg.com/736x/5b/6c/1d/5b6c1d66b2a967f60f60076959946602.jpg",
                tattoo_img: "http://mypaperimg.pchome.com.tw/newroot/h/a/hakah/content/20010410/14/218840.jpg",
                festival_img: "https://dcm.s3.hicloud.net.tw/nrch/678476/71578281-ccfc-4fe3-bd4d-8d6e46bd0da1.jpg"
            },
            {
                name: "賽夏族 (Saisiyat)",
                feature: "有祖靈信仰與矮靈信仰兩個大的類別。祖靈信仰與族人關係親近，影響族人生活運勢，矮靈信仰則與古老的歷史傳說有關。具有獨特的「臀鈴」樂器。",
                festival: "矮靈祭 (PaSta'ay)，或音譯巴斯達隘",
                symbol: "主要為紅、黑、白三色，與幾何紋路、日字紋、雷女紋（卍）",
                tattoo: "【有紋面】額頭與下巴線條，有鑿齒、穿耳文化。",
                image: "https://channelplus.ner.gov.tw/api/images/5c9326b1be337e0007fff9bc/1600/jpeg",
                symbol_img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT5JOr7XWXOg_3-TS0-ArW-C-3Q8u4tr5Culg&s",
                tattoo_img: "https://tme.ncl.edu.tw/images/tme_01/03/cca-1-20001-pc-tw-002414571-b.jpg",
                festival_img: "https://images.chinatimes.com/newsphoto/2022-11-06/1024/20221106001740.jpg"
            },
            {
                name: "雅美族 (Tao)",
                feature: "又稱達悟族，Tao是人的意思。雅美人的傳統信仰觀念中，分為神、鬼、人三類。充滿海洋文化、金銀飾，有獨特的地下屋建築、銀盔與拼板舟。",
                festival: "飛魚祭 (Rayon)",
                symbol: "船眼紋、波浪紋、人形紋",
                tattoo: "無紋面文化，有穿耳文化。",
                image: "https://dcm.s3.hicloud.net.tw/new/collection/2020-10-06/72e2136b-d6fb-409a-b5e8-edf9827a6d53/b9c7da52-3d4e-41ad-a6b3-e73350fa6524.jpg",
                symbol_img: "https://i.pinimg.com/474x/a7/4c/66/a74c668285829f5d75fa7bbb853a30ca.jpg",
                tattoo_img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiOSUAjEgn8bFXNLfxsZUzkYxX83ZftV5uZbI5p6RGpP9NT6WWUowZQimoOvXDMT0WXD2QvXJ4WBiOrkfD6sRSuO6Eg-Wmq6NeidwQhc1F6rcmRsiCvp3dXI0TWXpFJIErvdWSROw8jEgez/s640/15_1-2-02.jpg",
                festival_img: "https://comfortforest.weebly.com/uploads/1/4/1/3/14134855/2161400_orig.jpg"
            },
            {
                name: "邵族 (Thao)",
                feature: "深信祖靈信仰，位於日月潭周遭，有特殊的祖靈籃、杵音與「白鹿傳說」。",
                festival: "祖靈祭 (Lus'an)",
                symbol: "紅、白、黑、黃，最著名的為邵織紋",
                tattoo: "無紋面文化，有鑿齒、穿耳文化。",
                image: "https://data.boch.gov.tw/old_upload/_upload/Assets_new/relate_cultural/134728/photo/%E9%82%B5%E6%97%8F%E7%A5%96%E9%9D%88%E7%A5%AD1.jpg",
                symbol_img: "https://unews.nccu.edu.tw/wp-content/uploads/2021/05/a746691d8a9a4aa11c17ce1714c5564d-1024x327.jpg",
                tattoo_img: "https://cyberisland.teldap.tw/G/qwhcsUjsZtAdefbBItDulLs",
                festival_img: "https://www.taiwanhot.net/data/attachment/portal/201604/03/180238qw9xwnsiwmqdjdzw.jpg"
            },
            {
                name: "噶瑪蘭族 (Kavalan)",
                feature: "相信萬物有靈的觀念，並在靈魂的觀念中分為善靈、惡靈與自然靈。噶瑪蘭族目前仍保有全球特有編織香蕉絲的技術，非常具有特色。",
                festival: "豐年祭、海祭 (Laligi)",
                symbol: "白、藍、黑、紅，古時曾有許多複雜精緻圖案，現今多以簡樸、黑與白、圓形為主",
                tattoo: "無紋面、鑿齒、染齒文化。",
                image: "https://upload.wikimedia.org/wikipedia/commons/9/9d/Women_of_Kebalan_20150626.jpg",
                symbol_img: "https://img.ltn.com.tw/Upload/news/600/2022/03/10/3855578_7_1.jpg",
                tattoo_img: null,
                festival_img: "https://megapx-assets.dcard.tw/images/b8947802-65e5-4867-93dd-a1a335859313/640.jpeg"
            },
            {
                name: "太魯閣族 (Truku)",
                feature: "深信祖靈信仰 (Utux)，嚴守祖訓 Gaya，崇尚彩虹橋傳說，男子善獵，女子善織。",
                festival: "感恩祭 (Mgay Bari)",
                symbol: "菱形紋 (祖靈之眼)、橫條紋（彩虹橋的道路），與泰雅族相似。",
                tattoo: "【有紋面】與泰雅族類似，紋於額頭與下巴，象徵通過考驗，能歸於祖靈，也有鑿齒、穿耳文化。",
                image: "https://dcm.s3.hicloud.net.tw/new/collection/2020-10-06/23ac0c3d-89f7-4732-b94d-18b135564779/784e37c4-25cc-4338-9920-db1a8c61562e.jpg",
                symbol_img: "https://i.pinimg.com/736x/29/55/16/2955163a48959f96ea0a3cec8102e554.jpg",
                tattoo_img: "https://tme.ncl.edu.tw/images/tme_01/03/cca-1-20001-pc-tw-002414489-b.jpg",
                festival_img: "https://d3d4u6khyimoht.cloudfront.net/wp-content/uploads/2023/10/15191851/%E8%90%AC%E6%A6%AE%E9%84%89%E5%A4%AA%E9%AD%AF%E9%96%A3%E6%97%8F%E6%84%9F%E6%81%A9%E7%A5%AD-%E4%B8%BB%E9%AB%94%E6%9B%B2%E5%B1%95%E5%A4%9A%E5%85%83%E6%96%87%E5%8C%96.jpg"
            },
            {
                name: "撒奇萊雅族 (Sakizaya)",
                feature: "相信萬物有靈，超自然力量無所不在。曾因加禮宛事件，祖先遭清朝軍隊放火殘殺，而以火神祭弔唁祭祀祖先",
                festival: "火神祭 (Palamal)，射火箭、火燒屋",
                symbol: "土金、暗紅為主題，也有白、藍、黑，在該族「文化袋」可明顯看見，三角形源自於該族傳說，代表犧牲、奉獻與貞潔。",
                tattoo: "無紋面、鑿齒、染齒文化。",
                image: "https://www.titic.cip.gov.tw/public/order/1081204000014/image/%E9%99%84%E4%BB%B6%E7%85%A7%E7%89%871.jpg",
                symbol_img: "https://www.kirin.com.tw/barbeer/tingyuanminbar/content/images/2022/sakizaya_creature.png",
                tattoo_img: null,
                festival_img: "https://live.staticflickr.com/65535/52033425154_ef27a9e7bb_z.jpg"
            },
            {
                name: "賽德克族 (Seediq)",
                feature: "發源於白石山，重視祖靈與祖先的規矩Gaya，重視織布與紋面文化，是為人知曉的霧社事件發生地。",
                festival: "收穫祭（祖靈祭）、年祭、播種祭、獵首祭",
                symbol: "菱形紋 (祖靈之眼)、橫條紋（彩虹橋的道路），與泰雅族相似。",
                tattoo: "有紋面，男子紋額與下巴，女子紋兩頰，是對祖先規則Gaya的實踐和成年的標誌，也有鑿齒、穿耳文化。",
                image: "https://channelplus.ner.gov.tw/api/images/5c93260fbe337e0007fff98c/1600/jpeg",
                symbol_img: "https://img.ltn.com.tw/Upload/art/page/800/2022/09/03/4.jpg",
                tattoo_img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSB0AprMAiCbKgCit6z8zjHBQMqO5_BDlo5nQ&s",
                festival_img: "https://img.ltn.com.tw/Upload/news/600/2017/09/09/2188499_1.jpg"
            },
            {
                name: "拉阿魯哇族 (Hla'alua)",
                feature: "注重農耕祭儀，神靈信仰以貝神為主要祭祀對象。原居高雄桃源區，傳說曾與矮人共同生活，獲贈聖貝而有獨特祭典。",
                festival: "聖貝祭 (Miatungusu)",
                symbol: "紅、灰白、黃、綠、藍，貝神是拉阿魯哇族主要的圖騰象徵，服飾上也有明顯的貝類裝飾。",
                tattoo: "無紋面文化，有染齒、鑿齒、穿耳文化。",
                image: "https://news.pchome.com.tw/newsdata/living/7days/20220427/65106158479134295009.jpg",
                symbol_img: "https://vovo2000.com/images/68836.jpg",
                tattoo_img: null,
                festival_img: "https://www.taiwanhot.net/cache/426278/lg/wp-content-uploads-2017-02-58b3ef9cbdd19.jpg"
            },
            {
                name: "卡那卡那富族 (Kanakanavu)",
                feature: "傳統的信仰裡有「tinaravai 靈界」之說，在右肩者為「’incu善靈」，在左肩者為「’ucu 惡靈」。於高雄那瑪夏區，感謝天神與祖靈庇佑小米豐收與平安。",
                festival: "米貢祭 (Mikongu)",
                symbol: "藍、白、橘、紅、黃、綠，條紋顏色順序不可改變，女生服飾另有花布元素",
                tattoo: "無紋面文化，有穿耳、染齒文化。",
                image: "https://file.moc.gov.tw/001/Upload/OldFiles/AdminUploads/information/large/f94568eb-746d-4cf8-817f-a3f3d3a91ca5.jpg?0,399,0,224",
                symbol_img: "https://live.staticflickr.com/4348/36057555980_3414f67c5e_b.jpg",
                tattoo_img: null,
                festival_img: "https://imgcdn.cna.com.tw/www/WebPhotos/1024/20231015/1024x768_wmkn_0_C20231015000102.jpg"
            }
        ];

        // --- 主元件 ---
        const TaiwanMap = () => {
            const [geoData, setGeoData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedCounty, setSelectedCounty] = useState(null);
            const [hoveredCounty, setHoveredCounty] = useState(null);
            
            const [showTribesModal, setShowTribesModal] = useState(false);
            const [enlargedImage, setEnlargedImage] = useState(null);

            const [question, setQuestion] = useState('');
            const [qnaLoading, setQnaLoading] = useState(false);
            const [historyQnA, setHistoryQnA] = useState([
                { role: 'model', text: '你好！我是你的 AI 歷史導遊。關於這片土地的故事，有什麼想問的嗎？' }
            ]);

            const [scale, setScale] = useState(1);
            const [translate, setTranslate] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            
            const [mode, setMode] = useState('general');
            const [selectedPeriod, setSelectedPeriod] = useState('indigenous');

            const svgRef = useRef(null);
            const containerRef = useRef(null);
            const qnaScrollRef = useRef(null);
            const hasMovedRef = useRef(false);

            const apiKey = "AIzaSyBBhKBVb8TB-i4Oe03PBfysJKeS1kofDTk"; // 請填入您的 Gemini API Key 

            // --- 函式定義區 (確保在 return 前定義) ---

            const handleZoomIn = () => setScale(s => Math.min(s * 1.5, 5));
            const handleZoomOut = () => setScale(s => Math.max(s / 1.5, 1));
            const handleReset = () => { setScale(1); setTranslate({ x: 0, y: 0 }); setSelectedCounty(null); };

            const handleWheel = (e) => {
                const scaleAdjustment = -e.deltaY * 0.002;
                const newScale = Math.max(0.5, Math.min(10, scale + scaleAdjustment));
                setScale(newScale);
            };

            const handleMouseDown = (e) => {
                setIsDragging(true);
                setDragStart({ x: e.clientX - translate.x, y: e.clientY - translate.y });
                hasMovedRef.current = false;
            };

            const handleMouseMove = (e) => {
                if (isDragging) {
                    const newX = e.clientX - dragStart.x;
                    const newY = e.clientY - dragStart.y;
                    if (!hasMovedRef.current) {
                        const dist = Math.sqrt(Math.pow(newX - translate.x, 2) + Math.pow(newY - translate.y, 2));
                        if (dist > 2) hasMovedRef.current = true;
                    }
                    setTranslate({ x: newX, y: newY });
                }
            };

            const handleMouseUp = () => setIsDragging(false);
            const handleMouseLeave = () => { setIsDragging(false); setHoveredCounty(null); };

            const handleCountyClick = (e, name) => {
                e.stopPropagation();
                if (!hasMovedRef.current) {
                    setSelectedCounty(name === selectedCounty ? null : name);
                    // 移除 setHistoryQnA([]) 以保留對話記錄，提升體驗
                }
            };

            const handleAskLLM = async () => {
                if (!question.trim()) return;
                // 簡單檢查 (實際應用請填入 apiKey)
                if (!apiKey) {
                    setHistoryQnA(prev => [...prev, { role: 'user', text: question }, { role: 'model', text: "請先設定 API Key 才能使用 AI 問答功能。" }]);
                    setQuestion('');
                    return;
                }

                const userQuestion = question;
                setQuestion('');
                setQnaLoading(true);
                setHistoryQnA(prev => [...prev, { role: 'user', text: userQuestion }]);

                const displayCountyName = hoveredCounty || selectedCounty || '全台灣';
                const currentPeriodInfo = historyPeriods.find(p => p.id === selectedPeriod);
                const currentPeriodName = currentPeriodInfo ? currentPeriodInfo.name : '現代';
                
                const contextInfo = `
                  當前使用者狀態：
                  - 正在瀏覽地區：${displayCountyName}
                  - 當前模式：${mode === 'history' ? '歷史發展模式' : '一般地理資訊模式'}
                  - 當前歷史時期焦點：${mode === 'history' ? currentPeriodName : '現代'}
                `;

                const systemPrompt = `你是一位專業、親切且知識淵博的台灣歷史與地理導遊。
                請根據使用者的問題以及當前的瀏覽情境（Context）來回答。
                回答風格要生動有趣，適合大眾閱讀，但歷史事實必須嚴謹。
                請使用繁體中文回答。`;

                const userQuery = `${contextInfo}\n\n使用者的問題是：${userQuestion}`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            tools: [{ "google_search": {} }]
                        })
                    });
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate) {
                        const responseText = candidate.content?.parts?.[0]?.text || "抱歉，我現在無法回答這個問題。";
                        const sources = candidate.groundingMetadata?.groundingAttributions?.map(attr => ({
                            title: attr.web?.title || "資料來源",
                            uri: attr.web?.uri
                        })).filter(s => s.uri) || [];

                        setHistoryQnA(prev => [...prev, { role: 'model', text: responseText, sources: sources }]);
                    } else {
                         setHistoryQnA(prev => [...prev, { role: 'model', text: "API 回應無效，請稍後再試。" }]);
                    }
                } catch (error) {
                    setHistoryQnA(prev => [...prev, { role: 'model', text: "連線發生錯誤，請檢查 API Key 或網路。" }]);
                } finally {
                    setQnaLoading(false);
                }
            };

            const hasHistory = (countyName) => {
                return countyHistory[countyName] && countyHistory[countyName][selectedPeriod] && countyHistory[countyName][selectedPeriod] !== "-";
            };

            // 載入地圖資料
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await fetch('https://unpkg.com/taiwan-atlas/counties-10t.json');
                        const topology = await response.json();
                        const geojson = topojson.feature(topology, topology.objects.counties);
                        setGeoData(geojson);
                        setLoading(false);
                    } catch (error) {
                        console.error("Failed to load map data:", error);
                        setLoading(false);
                    }
                };
                loadData();
            }, []);

            // 自動捲動對話框
            useEffect(() => {
                if (qnaScrollRef.current) {
                    qnaScrollRef.current.scrollTop = qnaScrollRef.current.scrollHeight;
                }
            }, [historyQnA, showTribesModal]);


            // 渲染變數準備
            const displayCounty = hoveredCounty || selectedCounty;
            const currentPeriodInfo = historyPeriods.find(p => p.id === selectedPeriod);
            const displayedCountyData = displayCounty ? (countyData[displayCounty] || {}) : {};
            const displayedCountyHistory = displayCounty ? (countyHistory[displayCounty] || {}) : {};

            // --- 渲染地圖 (Render Map) ---
            const renderMap = () => {
                if (!geoData) return null;
                const projection = d3.geoMercator().center([120.9, 23.7]).scale(8000).translate([300, 350]);
                const pathGenerator = d3.geoPath().projection(projection);
                
                const activeColor = currentPeriodInfo ? currentPeriodInfo.color : '#3b82f6';
                const islandScales = { "澎湖縣": 1.8, "金門縣": 2.2, "連江縣": 3.0 };

                return (
                    <g transform={`translate(${translate.x}, ${translate.y}) scale(${scale})`}>
                        {geoData.features.map((feature, i) => {
                            const rawName = feature.properties.name || feature.properties.COUNTYNAME;
                            const name = normalizeName(rawName);
                            const isSelected = selectedCounty === name;
                            const isHovered = hoveredCounty === name;
                            
                            let fillColor = "#e2e8f0";
                            let strokeColor = "#374151";
                            
                            // 這裡需要用 hasHistory(name)
                            const hasEvent = hasHistory(name);
                            const displayForColor = displayCounty;

                            if (mode === 'history') {
                                if (name === displayForColor) {
                                    fillColor = activeColor;
                                    strokeColor = "#fbbf24";
                                } else if (hasEvent) {
                                    fillColor = `${activeColor}66`;
                                } else {
                                    fillColor = "#f1f5f9";
                                }
                            } else {
                                fillColor = name === displayForColor ? "#3b82f6" : isHovered ? "#93c5fd" : "#e2e8f0";
                            }

                            const islandScale = islandScales[name] || 1;
                            const [cx, cy] = pathGenerator.centroid(feature);
                            // 修正 transform 語法
                            const pathTransform = islandScale > 1 ? `translate(${cx}, ${cy}) scale(${islandScale}) translate(-${cx}, -${cy})` : undefined;
                            const baseStrokeWidth = (mode === 'history' && hasEvent) ? 1.5 : 1;
                            const finalStrokeWidth = baseStrokeWidth / islandScale;

                            return (
                                <path
                                    key={i}
                                    d={pathGenerator(feature)}
                                    fill={fillColor}
                                    stroke={strokeColor}
                                    strokeWidth={finalStrokeWidth}
                                    transform={pathTransform}
                                    className={`transition-colors duration-200 ease-in-out ${isDragging ? 'cursor-grabbing' : 'cursor-pointer'}`}
                                    onMouseEnter={() => !isDragging && setHoveredCounty(name)}
                                    onMouseLeave={() => setHoveredCounty(null)}
                                    onClick={(e) => handleCountyClick(e, name)}
                                />
                            );
                        })}
                    </g>
                );
            };

            return (
                <div className="flex flex-col h-screen w-screen bg-slate-50 font-sans text-slate-800 overflow-hidden relative">
                    {/* Header */}
                    <header className="flex-none bg-white/90 backdrop-blur shadow-sm z-40 relative">
                        <div className="p-4 flex items-center justify-between border-b border-slate-100">
                            <div className="flex items-center gap-2">
                                <MapIcon className={`w-6 h-6 ${mode === 'history' ? 'text-amber-600' : 'text-blue-600'}`} />
                                <h1 className="text-xl font-bold text-slate-800">
                                    {mode === 'history' ? '台灣歷史與文化地圖' : '台灣行政區互動地圖'}
                                </h1>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-lg gap-2">
                                <button onClick={() => { setMode('general'); setSelectedCounty(null); }} className={`px-3 py-1.5 text-sm rounded-md flex items-center gap-2 ${mode === 'general' ? 'bg-white shadow text-blue-600 font-medium' : 'text-slate-500'}`}>
                                    <Info className="w-4 h-4" /> 一般資訊
                                </button>
                                <button onClick={() => { setMode('history'); setSelectedCounty(null); }} className={`px-3 py-1.5 text-sm rounded-md flex items-center gap-2 ${mode === 'history' ? 'bg-white shadow text-amber-600 font-medium' : 'text-slate-500'}`}>
                                    <BookOpen className="w-4 h-4" /> 歷史模式
                                </button>
                                <button onClick={() => setShowTribesModal(true)} className="px-3 py-1.5 text-sm rounded-md flex items-center gap-2 text-slate-500 hover:text-green-700 hover:bg-green-50">
                                    <Users className="w-4 h-4" /> 原住民族 16 族介紹
                                </button>
                            </div>
                        </div>
                        {mode === 'history' && (
                            <div className="px-4 py-3 bg-stone-100 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2 border-b border-stone-200">
                                {historyPeriods.map((period) => {
                                    const PeriodIcon = period.icon;
                                    return (
                                        <button 
                                            key={period.id} 
                                            onClick={() => { setSelectedPeriod(period.id); setSelectedCounty(null); }} 
                                            className={`px-4 py-2 rounded-full text-sm font-medium border flex items-center gap-2 ${selectedPeriod === period.id ? 'text-white shadow-md border-transparent' : 'bg-white text-slate-600 border-slate-200'}`} 
                                            style={{ backgroundColor: selectedPeriod === period.id ? period.color : undefined }}
                                        >
                                            <PeriodIcon className="w-4 h-4" />
                                            <span>{period.name}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </header>

                    {/* Modal */}
                    {showTribesModal && (
                        <div className="absolute inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden relative animate-fadeIn">
                                <div className="bg-green-700 text-white p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-3"><Feather className="w-6 h-6" /><h2 className="text-xl font-bold">台灣原住民族 16 族介紹</h2></div>
                                    <button onClick={() => setShowTribesModal(false)} className="p-1 hover:bg-white/20 rounded-full"><X className="w-6 h-6" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 bg-slate-50 custom-scrollbar">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {tribesData.map((tribe, index) => (
                                            <div key={index} className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                                                <h3 className="text-lg font-bold text-green-800 mb-2 border-b border-green-100 pb-2">{tribe.name}</h3>
                                                {tribe.image && (
                                                    <div className="mb-4 rounded-lg overflow-hidden border border-slate-100 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.image, alt: tribe.name })}>
                                                        <img src={tribe.image} alt={`${tribe.name} 示意圖`} className="w-full h-48 object-cover hover:scale-105 transition-transform duration-500" onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x400/CCCCCC/374151?text=圖片載入失敗"; }} />
                                                    </div>
                                                )}
                                                <div className="space-y-3 text-sm flex-1">
                                                    <div><span className="text-xs font-bold text-slate-400 block mb-1">特色</span><p className="text-slate-700">{tribe.feature}</p></div>
                                                    {tribe.symbol_img && (
                                                        <div className='flex items-start gap-3'>
                                                            <div className="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden border border-slate-300 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.symbol_img, alt: `${tribe.name} 圖騰` })}>
                                                                <img src={tribe.symbol_img} className="w-full h-full object-cover" onError={(e) => { e.target.src="https://placehold.co/100x100/CCCCCC/374151?text=圖騰"; }} />
                                                            </div>
                                                            <div><span className="text-xs font-bold text-slate-400 block mb-1">文化圖騰與意義</span><p className="text-slate-700 font-medium">{tribe.symbol}</p></div>
                                                        </div>
                                                    )}
                                                    {tribe.tattoo_img ? (
                                                        <div className='flex items-start gap-3'>
                                                            <div className="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden border border-slate-300 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.tattoo_img, alt: `${tribe.name} 紋面` })}>
                                                                <img src={tribe.tattoo_img} className="w-full h-full object-cover" onError={(e) => { e.target.src="https://placehold.co/100x100/CCCCCC/374151?text=紋面"; }} />
                                                            </div>
                                                            <div><span className="text-xs font-bold text-slate-400 flex items-center gap-1 mb-1"><Brush className="w-3 h-3 text-red-400"/> 紋面/紋身</span><p className="text-slate-700 italic">{tribe.tattoo}</p></div>
                                                        </div>
                                                    ) : (
                                                        <div><span className="text-xs font-bold text-slate-400 flex items-center gap-1 mb-1"><Brush className="w-3 h-3 text-red-400"/> 紋面/紋身</span><p className="text-slate-700 italic">{tribe.tattoo}</p></div>
                                                    )}
                                                    {tribe.festival_img && (
                                                        <div className='flex items-start gap-3 pt-2 mt-auto'>
                                                            <div className="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden border border-slate-300 cursor-zoom-in" onClick={() => setEnlargedImage({ src: tribe.festival_img, alt: `${tribe.name} 慶典` })}>
                                                                <img src={tribe.festival_img} className="w-full h-full object-cover" onError={(e) => { e.target.src="https://placehold.co/100x100/CCCCCC/374151?text=慶典"; }} />
                                                            </div>
                                                            <div><span className="text-xs font-bold text-slate-400 block mb-1">重要慶典</span><p className="font-medium text-green-600 bg-green-50 px-2 py-1 rounded inline-block">{tribe.festival}</p></div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-6 text-center text-xs text-slate-400">資料來源：原住民族委員會 (CIP) 及相關文化研究</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Enlarged Image */}
                    {enlargedImage && (
                        <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 cursor-zoom-out" onClick={() => setEnlargedImage(null)}>
                            <div className="relative w-full h-full max-w-6xl max-h-[90vh] flex items-center justify-center">
                                <img src={enlargedImage.src} alt={enlargedImage.alt} className="object-contain max-h-full max-w-full rounded-lg shadow-2xl" />
                                <button className="absolute top-4 right-4 text-white p-2 rounded-full bg-black/50 hover:bg-black/70" onClick={() => setEnlargedImage(null)}><X className="w-8 h-8" /></button>
                                <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-lg text-sm">{enlargedImage.alt} - 點擊任意處關閉</div>
                            </div>
                        </div>
                    )}

                    <div className="flex-1 relative overflow-hidden">
                        <div 
                            ref={containerRef}
                            className={`absolute inset-0 transition-colors duration-500 ${mode === 'history' ? 'bg-stone-50' : 'bg-blue-50'} ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
                            onWheel={handleWheel}
                            onMouseDown={handleMouseDown}
                            onMouseMove={handleMouseMove}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseLeave}
                            onTouchStart={() => setIsDragging(true)}
                            onTouchEnd={() => setIsDragging(false)}
                            onClick={() => { if(!hasMovedRef.current) setSelectedCounty(null); }}
                        >
                            {loading ? (
                                <div className="flex items-center justify-center h-full gap-2 text-slate-500 animate-pulse"><Loader2 className="w-6 h-6 animate-spin" /><span>載入地圖資料中...</span></div>
                            ) : (
                                <>
                                    {mode === 'history' && (
                                        <div className="absolute top-4 left-4 p-4 max-w-xs z-0 pointer-events-none select-none">
                                            <h3 className="text-2xl font-bold text-slate-300" style={{ color: `${currentPeriodInfo.color}88` }}>{currentPeriodInfo.name}</h3>
                                            <p className="text-slate-400 text-sm mt-1 font-medium opacity-80">{currentPeriodInfo.year}</p>
                                            <p className="text-slate-500 text-sm mt-2">{currentPeriodInfo.desc}</p>
                                        </div>
                                    )}
                                    <div className="absolute top-4 right-4 bg-white/80 backdrop-blur px-2 py-1 rounded text-xs text-slate-400 pointer-events-none select-none z-0">滾輪縮放 • 拖曳移動</div>
                                    <svg ref={svgRef} viewBox="0 0 600 700" className="w-full h-full drop-shadow-xl z-10 select-none">
                                        <defs><filter id="glow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="2" result="blur" /><feComposite in="SourceGraphic" in2="blur" operator="over" /></filter></defs>
                                        {renderMap()}
                                    </svg>
                                </>
                            )}
                            <div className="absolute bottom-6 left-6 flex flex-col gap-2 bg-white p-2 rounded-lg shadow-lg border border-slate-200 z-10" onMouseDown={(e) => e.stopPropagation()}>
                                <button onClick={handleZoomIn} className="p-2 hover:bg-slate-100 rounded text-slate-600" title="放大"><ZoomIn className="w-5 h-5" /></button>
                                <button onClick={handleZoomOut} className="p-2 hover:bg-slate-100 rounded text-slate-600" title="縮小"><ZoomOut className="w-5 h-5" /></button>
                                <button onClick={handleReset} className="p-2 hover:bg-slate-100 rounded text-slate-600" title="重置視角"><Maximize className="w-5 h-5" /></button>
                            </div>
                        </div>

                        {/* Right Side Panel */}
                        <div className={`absolute top-4 bottom-4 right-4 w-72 bg-white/95 backdrop-blur-md shadow-2xl rounded-2xl border border-white/50 transform transition-transform duration-300 ease-out z-30 flex flex-col overflow-hidden ${displayCounty ? 'translate-x-0' : 'translate-x-[120%]'}`}>
                            {displayCounty && (
                                <div className="h-full flex flex-col">
                                    <div className="p-4 border-b flex justify-between items-center text-white transition-colors duration-300 flex-none" style={{ backgroundColor: mode === 'history' ? currentPeriodInfo.color : '#2563eb' }}>
                                        <h2 className="text-xl font-bold flex items-center gap-2">{displayCounty}{mode === 'history' && <span className="text-xs bg-white/20 px-2 py-1 rounded border border-white/30">{currentPeriodInfo.name}</span>}</h2>
                                        {selectedCounty && <button onClick={() => setSelectedCounty(null)} className="hover:bg-white/20 p-1 rounded transition-colors"><X className="w-5 h-5" /></button>}
                                    </div>
                                    <div className="p-5 space-y-5 overflow-y-auto flex-1 custom-scrollbar">
                                        {/* Q&A */}
                                        <div className="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                            <h4 className="flex items-center gap-2 text-sm font-bold text-yellow-800 mb-3"><MessageSquare className="w-4 h-4" /> ✨ 歷史問答</h4>
                                            <div ref={qnaScrollRef} className="space-y-3 max-h-40 overflow-y-auto mb-3 pr-2">
                                                {historyQnA.map((item, i) => (
                                                    <div key={i} className={`flex ${item.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                        <div className={`max-w-[85%] p-2 rounded-lg text-xs ${item.role === 'user' ? 'bg-blue-200 text-slate-800' : 'bg-white shadow text-slate-700'}`}>
                                                            <p>{item.text}</p>
                                                            {item.sources?.length > 0 && <div className="mt-1 pt-1 border-t border-slate-200 text-[10px] text-slate-500">來源: {item.sources.map((s, si) => <a key={si} href={s.uri} target="_blank" className="block truncate hover:underline">- {s.title}</a>)}</div>}
                                                        </div>
                                                    </div>
                                                ))}
                                                {qnaLoading && <div className="text-xs text-slate-500 animate-pulse">AI 思考中...</div>}
                                            </div>
                                            <div className="flex gap-2">
                                                <input type="text" value={question} onChange={e => setQuestion(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAskLLM()} placeholder={`關於 ${displayCounty}...`} className="flex-1 px-3 py-2 text-sm border rounded-lg" disabled={qnaLoading} />
                                                <button onClick={handleAskLLM} disabled={qnaLoading || !question.trim()} className="p-2 bg-yellow-600 text-white rounded-lg disabled:bg-yellow-400"><Send className="w-4 h-4" /></button>
                                            </div>
                                        </div>

                                        {mode === 'general' ? (
                                            <div className="space-y-4">
                                                <div className="flex items-start gap-3"><div className="p-2 bg-blue-100 text-blue-600 rounded-lg"><Info className="w-5 h-5" /></div><div><p className="text-xs text-slate-500 mb-1">地方特色</p><p className="font-medium text-sm">{displayedCountyData.feature}</p></div></div>
                                                <div className="grid grid-cols-1 gap-3">
                                                    <div className="bg-slate-50 p-3 rounded-lg border"><p className="text-xs text-slate-500 mb-1">人口</p><p className="font-semibold">{displayedCountyData.population}</p></div>
                                                    <div className="bg-slate-50 p-3 rounded-lg border"><p className="text-xs text-slate-500 mb-1">面積</p><p className="font-semibold">{displayedCountyData.area}</p></div>
                                                </div>
                                                <button onClick={() => setMode('history')} className="w-full py-2 bg-stone-100 text-stone-700 rounded-lg text-xs font-medium hover:bg-stone-200 flex justify-center gap-2"><BookOpen className="w-4 h-4" /> 查看歷史發展</button>
                                            </div>
                                        ) : (
                                            <div className="space-y-5 animate-fadeIn">
                                                <div className="p-4 rounded-xl border bg-opacity-10 border-opacity-20" style={{ backgroundColor: `${currentPeriodInfo.color}11`, borderColor: currentPeriodInfo.color }}>
                                                    <div className="flex items-center gap-2 mb-3" style={{ color: currentPeriodInfo.color }}>{currentPeriodInfo.icon}<h3 className="font-bold text-sm">{currentPeriodInfo.name} ({currentPeriodInfo.year})</h3></div>
                                                    <div className="text-slate-700 leading-relaxed font-medium text-sm">
                                                        {displayedCountyHistory[selectedPeriod] && displayedCountyHistory[selectedPeriod] !== "-" ? displayedCountyHistory[selectedPeriod] : <span className="text-slate-400 italic text-xs">此時期該區域尚無重大開發紀錄。</span>}
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider px-1">該地區歷史軌跡</h4>
                                                    <div className="relative border-l-2 border-slate-100 ml-2 space-y-4 pb-2">
                                                        {historyPeriods.map(period => {
                                                            if (period.id === selectedPeriod) return null;
                                                            const txt = countyHistory[displayCounty]?.[period.id];
                                                            if (!txt || txt === "-") return null;
                                                            return (
                                                                <div key={period.id} className="relative pl-5 group cursor-pointer" onClick={() => { setSelectedPeriod(period.id); setSelectedCounty(null); }}>
                                                                    <div className="absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full border-2 border-white" style={{ backgroundColor: period.color }}></div>
                                                                    <div className="mb-1"><span className="text-xs font-bold" style={{ color: period.color }}>{period.name}</span></div>
                                                                    <p className="text-xs text-slate-500 line-clamp-2 hover:line-clamp-none">{txt}</p>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <TaiwanMap />
            </ErrorBoundary>
        );
    </script>
</body>
</html>











